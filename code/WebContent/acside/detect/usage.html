<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>use sample</title>
<script type="text/javascript">
orderjs("app.plot");
orderjs(function(){
	var mainDirect = new JqueryAjaxDirect({
		services : {
			"getDetectFlowSummary" : function(options){
				var url = rl.format("${base}detect/getFlowSummaryTotal.do?branchId=${branchId}", arguments),
					data = jQuery("#searchForm").serialize();
				rl.debug(this + ' url = ' + url + '');
				jQuery.ajax(rl.ext(options, { url : url, data : data}));
			}
		}
	});
	function updateFlowSummary(){
		var view = flowSummaryPlot;
		mainDirect.invoke("getDetectFlowSummary", {
			beforeSend : function(){
				view.showTip("Loading...");
			},
			success : function(){
				view.update();
			},
			error : function(){
				view.update();
			},
			complete : function(){
				view.update();
			}
		});
		
	}
	mainController.on("query", updateFlowSummary);
	
	var mainController = new ReportController({
		direct : mainDirect
	});
	
	mainController.on("query", function(){
		var me = this;
		this.invoke("getDetectFlowSummary", "get..");
	});
	
	mainController.on("query", function(){
		mainDirect.invoke("getDetectFlowSummary", {
			success : function(data){
				flowSummary.view.update(data);
			},
			error : function(data){
				flowSummary.view.update(data);
			}
		});
	});
	
	
	rl.onDeco(function(){
		jQuery("#timeTypeSeletor:has(li a[href='#custom'])")
			.getDecorator()
			.on("change", function(value){
				if(value == "custom"){
					jQuery("#timeType_custom_ctrl").show();
				}
				else{
					jQuery("#timeType_custom_ctrl").hide();
					mainController.fireEvent("query");
				}
			});
		
		function Controller(options){
			this.initialize(options);
		}
		Controller.prototype = {
			ds : null,
			view : null,
			initialize : function(options){
				this.setOptions(options);
				this.initEvents();
			},
			initEvents : function(){
				var me = this;
				this.ds.on("load", function(data){
					me.view.update(data);
				});
				this.ds.on("loaderror", function(err){
					me.view.showErr(err);
				});
			}
		};
		
		function DataSource(){
			this.initialize(options);
		}
		DataSource.prototype = {
			initialize : function(options){
				this.setOptions(options);
				this.initEvents();
			},
			load : function(options){
				var me = this,
					opt = rl.ext({url : this.url}, (this.getSendData || rl.EMPTY_FUNCTION)(options));
				
				jQuery.ajax(rl.fill({
					success : function(){
						
						me.fireEvent("load");
					},
					error : function(){
						
						me.fireEvent("loadError");
					}
				}, opt));
			}
		};
		//flowSummary
		var flowSummary = new Controller({
			ds : new DataSource({
				getSendData : function(options){
					var url = rl.format("${base}detect/getFlowSummaryTotal.do?branchId=${branchId}", arguments),
						data = jQuery("#searchForm").serialize();
					
					return rl.ext(options, { url : url, data : data});
				}
			}),
			view : "table[rl-deco='dataBinding']"
		});
		flowSummary.view.showErr = function(err){
			this.jq
				.find(".cell .num")
				.html("<span class='warn'>N/A</span>");
		};
		mainController.on("query", function(){
			flowSummary.ds.load();
		});
		
		//optimize
		rl.pageController.add(ds, view);
	});
	
	
});
</script>
<style type="text/css">
.rl_options,
options{
	display:none;
}
</style>
</head>

<body>
	<!-- deco with registered type -->
    <table rl-deco="dataBinding" rl-deco-embedded="" rl-rl-deco-options="" class="layout" border="0" cellspacing="0" cellpadding="0">
        <tr>
            <td class="cell">
                <table class="canvas" border="0" cellspacing="0" cellpadding="0">
                    <tr>
                        <td class="num" data-bind="detectTotal">-</td>
                        <td class="name">探测数</td>
                    </tr>
                </table>
            </td>
            <td class="cell">
                <table class="canvas" border="0" cellspacing="0" cellpadding="0">
                    <tr>
                        <td class="num" data-bind="enterTotal">-</td>
                        <td class="name">进店数</td>
                    </tr>
                </table>
            </td>
            <td class="cell">
                <table class="canvas" border="0" cellspacing="0" cellpadding="0">
                    <tr>
                        <td class="num" data-bind="authTotal">-</td>
                        <td class="name">认证数</td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <!-- deco with speicify decorator id (should starts with #) -->
    <table rl-deco="#flowSummaryStat" class="layout" border="0" cellspacing="0" cellpadding="0">
        <tr>
            <td class="cell">
                <table class="canvas" border="0" cellspacing="0" cellpadding="0">
                    <tr>
                        <td class="num" data-bind="detectTotal">-</td>
                        <td class="name">探测数</td>
                    </tr>
                </table>
            </td>
            <td class="cell">
                <table class="canvas" border="0" cellspacing="0" cellpadding="0">
                    <tr>
                        <td class="num" data-bind="enterTotal">-</td>
                        <td class="name">进店数</td>
                    </tr>
                </table>
            </td>
            <td class="cell">
                <table class="canvas" border="0" cellspacing="0" cellpadding="0">
                    <tr>
                        <td class="num" data-bind="authTotal">-</td>
                        <td class="name">认证数</td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <script type="text/javascript">
	orderjs(function(){
		//dynamic register a decorator
		rl.addDecorator("flowSummaryStat", {
			"load" : function(data){
				jQuery("#detectTotal").text(data.detectTotal);
				jQuery("#enterTotal").text(data.enterTotal);
				jQuery("#authTotal").text(data.authTotal);
			},
			"loading" : function(){
				
			}
		});
	});
	</script>
    <!-- deco with gui type, and add extra behaviours -->
    <div class="search_bar">
        <div rl-deco="RadioButton" id="timeTypeSeletor" class="jquery_idtabs radio_btn ctrl">
            <input type="hidden" name="tag" value="today" autoComplete="off" />
            <ul class="tabbar">
                <li><a href="#today">今天</a></li>
                <li><a href="#yesterday">昨天</a></li>
                <li><a href="#7day">近7天</a></li>
                <li><a href="#30day">近30天</a></li>
                <li><a href="#custom">自定义</a></li>
            </ul>
        </div>
        <div id="timeType_custom_ctrl" class="ctrl" style="padding-top:5px; margin-left:1em; display:none;">
            <span id="startTimeCtn"></span>
            <span id="endTimeCtn"></span>
        </div>
        <div class="clearer"></div>
    </div>
    <script type="text/javascript">
	orderjs(function(){
		rl.onDeco(function(){
			jQuery("#timeTypeSeletor:has(li a[href='#custom'])")
				.getDecorator()
				.on("change", function(value){
					if(value == "custom"){
						jQuery("#timeType_custom_ctrl").show();
					}
					else{
						jQuery("#timeType_custom_ctrl").hide();
						searchMgr.fireEvent("search");
					}
				});
		});
	});
	</script>
    
    <!-- deco with gui type, and provide more comp options -->
    <div class="section section_unite">
        <div id="mainStatCtn" class="chart_wrapper">
            <div class="loading_tip desc">数据加载中...</div>
            <div rl-deco="rl.plot.Pie" rl-deco-options="{
                plotOptions : {
                    legend:{
                        show:true,
                        rendererOptions: {
                            numberColumns: 2
                        },
                        location:'e'
                    },
                    highlighter : {
                        show:true,
                        showTooltip : true,
                        tooltipLocation: 's',
                        useAxesFormatters: false,
                        formatString:'%s, %P'
                    }
                }
            }" id="mainStatHolder" style="height:100%;"></div>
        </div>
        <script type="text/javascript">
            orderjs(
                "app.dataBox.jqplotPies",
                "open.jqplot.plugins.jqplot-highlighter"
            );
            orderjs(function(){
                var jQuery = orderjs("open.jquery.jquery");
                var mainPlot = new rl.dataBox.KpiViewPlot({
                    renderTarget : "mainStatHolder",
                    shapeType : "pie",
                    plotOptions : {
                        legend:{
                            show:true,
                            //placement: 'outside',
                            rendererOptions: {
                                numberColumns: 2
                            },
                            location:'e'
                        },
                        highlighter : {
                            show:true,
                            showTooltip : true,
                            tooltipLocation: 's',
                            useAxesFormatters: false,
                            formatString:'%s, %P'
                        }
                    }
                });
                                            
                var loadTip = new PlotLoadTip("#mainStatCtn .loading_tip", mainPlot);							
                function updatePlot(){
                    var url = "${base}detect/getBrandSummary.do?branchId=${branchId}",
                        data = jQuery("#searchForm").serialize();
                    
                    var url = "${base}acside/detect/brandSummary.today.txt?";
                    rl.debug(this + ' url = ' + url + ' data = ' + data + '');                                
                    ajaxPlotData(url, mainPlot, loadTip, {data : data});
                }
                searchMgr.on("search", updatePlot);
                updatePlot();
            });
        </script>
    </div>
    
	<div rl-ctype="plot" data-options="{
        shapeType : 'pie',
        plotOptions : {
            legend:{
                show:true,
                rendererOptions: {
                    numberColumns: 2
                },
                location:'e'
            },
            highlighter : {
                show:true,
                showTooltip : true,
                tooltipLocation: 's',
                useAxesFormatters: false,
                formatString:'%s, %P'
            }
        }
    }">
    </div>
    <script type="text/javascript">
	
	</script>
	<div rl-ctype="plot">
    	<options>
            {
                shapeType : "pie",
                plotOptions : {
                    legend:{
                        show:true,
                        rendererOptions: {
                            numberColumns: 2
                        },
                        location:'e'
                    },
                    highlighter : {
                        show:true,
                        showTooltip : true,
                        tooltipLocation: 's',
                        useAxesFormatters: false,
                        formatString:'%s, %P'
                    }
                }
            }
        </options>
        hellow options!
    </div>
	<div class="data_list" rl-ctype="datalist" rl-url="${base}getDataList.do?dd"></div>
    <div class="rl_grid" rl-url="${base}getGridData.do?dd">
    	<div class="pagingbar"></div>
    </div>
</body>
</html>
