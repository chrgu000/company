/**
 * @fileOverview Rpc engine.
 * @change
 	#1 by prcjack Creates file.
	#2 by prcjack @2014/05/29 Merged "lib.rpc.IHRequest", "lib.rpc.XHRequest"
 */
orderjs.define("lib.rpc.engine",["lib.data.engine","lib.dom.engine"],function(){var rpc=rl.rpc;rl.ext(rl.rpc,{URL_BLANK:"about:blank",_XHRTransportPool:[],_IHRTransportPool:[],_msXmlHttpArr:["MSXML2.XMLHTTP.5.0","MSXML2.XMLHTTP.4.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","Microsoft.XMLHTTP"],appendUrlRandom:function(t,e,r){return e=e||"random",r=r||(new Date).getTime(),t+=(t.contains("?")?"&":"?")+e+"="+r},createXHRTransport:rl.createXHRTransport,getXHRTransport:function(){for(var t,e=rpc._XHRTransportPool,r=0,s=e.length;s>r;r++)if(t=e[r].readyState,0==t||4==t)return e[r];return e.push(rl.createXHRTransport()),e[e.length-1]},_onReadyStateChange:function(t,e){var r,s,n=e.scope,i=rl.EMPTY_FUNCTION;try{r=t.readyState,4==r?(s=rl.isRequestOk(t)?"Success":"Failure",(e["on"+s]||i).call(n,t),t.onreadystatechange=i):r>0&&(s="Loading",(e.onLoading||i).call(n,t))}catch(o){var a=s?"Request's on"+s+" handler occurs error:"+o:o;rl.debug(this+"-> _onReadyStateChange(): error occurs on request = "+t,"err"),rl.dir(rl.ext({requestReadyState:r,requestState:s,requestUrl:e.url,cause:a},o),"Request error report","err"),(e.onError||i).call(e.scope,o,t)}},xhr:function(t,e){e=rl.ext({async:!0,method:"post",listen:!0,postData:null},e);var r=e.transport;try{r||(r=rpc.getXHRTransport()),r.open(e.method,t,e.async),e.listen&&(r.onreadystatechange=Function.curry(rpc._onReadyStateChange,r,e));for(var s in e.headers)r.setRequestHeader(s,e.headers[s]);if(r.send(e.postData),!e.listen)try{(e.onSuccess||rl.EMPTY_FUNCTION).call(e.scope,r)}catch(n){throw rl.ext({cause:"Request's onSuccess handler occurs error: "+n},n)}return r}catch(n){rl.debug(this+"-> xhr(): error occurs on request = "+r,"err"),rl.dir(rl.ext({requestUrl:e.url},n),"Request error report","err"),(e.onError||rl.EMPTY_FUNCTION).call(e.scope,n,r)}}}),rl.rpc.AbstractHR=rl.createClass({parent:rl.util.EventProvider,construct:function(t){rl.isPrototyping(arguments[0])||(rl.rpc.AbstractHR.parent.call(this,t),rl.ext(this,t))},members:{method:"post",url:"",sendData:null,sendDataType:"urlencoded",timeout:60,requestInterval:60,requesting:!1,_timeoutTimer:0,getTransport:function(){return this._transport},reRequest:function(){return this.request(this._requestOptions)},_afterRequest:function(){this.requesting=!1,clearTimeout(this._timeoutTimer)},_hndTimeout:function(){this.fireEvent("timeout")},startIntervalRequest:function(t){var e=1e3*this.requestInterval;this._intervalTimer=Function.interval(this.request,e,this),t&&this.request()},stopIntervalRequest:function(){window.clearInterval(this._intervalTimer)},reStartIntervalRequest:function(t){isNaN(t)||(this.requestInterval=t),this.stopIntervalRequest(),this.startIntervalRequest(!1)},toString:function(){return"[object rl.rpc.AbstractHR]"}}}),function(){var rpc=rl.rpc;rpc.XHRequest=rl.createClass({parent:rpc.AbstractHR,construct:function(t){rl.isPrototyping(arguments[0])||(rl.rpc.XHRequest.parent.call(this,t),this.createTransport())},members:{async:!0,headers:null,disableCache:!0,disableCacheParam:"_dcp",disableDefaultHeaders:!1,defaultHeaders:{"Framework-Name":"RealLight","Framework-Version":rl.version,"X-Requested-With":"XMLHttpRequest"},responseType:"text",abort:function(){return this.requesting&&(this._transport.abort(),this._afterRequest(),this.fireEvent("abort")),this},createTransport:function(){return this._transport=rl.createXHRTransport(),this},_initOptions:function(t){var e,r,s=(t.dataType||"").toLowerCase(),n=t.headers||{},i=t.sendData||this.sendData;if(i){if(r="post","xml"==s)e="text/xml",t.method="post";else if("form"==s||rl.isNonNullStr(i)||rl.isElement(i)&&i.tagName.equalsIgnoreCase("form")){var o=rl.getDom(i)||document.forms[i];if(rl.isElement(o)){var a=o.method||o.getAttribute("method");t.url=t.url||o.action||o.getAttribute("action"),i=rl.data.encodeForm2QS(o),e="application/x-www-form-urlencoded",a&&(r=a)}}else e="application/x-www-form-urlencoded",("json"==s||rl.isObject(i))&&(i=rl.data.encode2QS(i));n["Content-Type"]=n["Content-Type"]?n["Content-Type"]+","+e:e}else r="get";t.method||(t.method=r),t.url||(t.url=this.url||""),"get"==t.method&&i&&(t.url+=(t.url.contains("?")?"&":"?")+i,i=null);var u=t.disableCache===!1?!1:this.disableCache;u&&(t.url=rpc.appendUrlRandom(t.url)),t.postData=i,rl.isNonNullStr(t.dynamicParams)&&(t.url+=(t.url.contains("?")?"&":"?")+t.dynamicParams);var l=t.disableDefaultHeaders===!1?!1:this.disableDefaultHeaders;l||rl.fill(n,this.defaultHeaders),t.headers=n,isNaN(t.timeout)&&(t.timeout=this.timeout),t.async=t.async===!1?!1:this.async},request:function(t){if(this.requesting||this.fireEvent("beforerequest",t)===!1)return this;this.requesting=!0,t=this._requestOptions=t||{},rl.dir(t,this+" ->request(): Provided options"),this._initOptions(t);var e=t.async;return rl.ext(t,{transport:this._transport,async:e,listen:e,scope:this,onSuccess:this._hndSuccess,onFailure:this._hndFailure,onLoading:this._hndLoading,onError:this._hndError}),rl.dir(t,this+" ->request(): Computed options"),e&&this.timeout>0&&(this._timeoutTimer=Function.delay(this._hndTimeout,1e3*this.timeout,this)),rl.rpc.xhr(t.url,t),this},reRequest:function(){return this.request(this._requestOptions)},getResponse:function(t){return this.requesting?void 0:(t=(t||this.responseType).toLowerCase(),rpc.XHRequest.responseHandlers[t](this._transport))},getResponseHeader:function(){},getAllResponseHeaders:function(){},_hndSuccess:function(t){var e,r=this._requestOptions||{},s=r.successHandler||this.successHandler,n=r.failureHandler||this.failureHandler;this._afterRequest();try{e=this.getResponse(r.responseType)}catch(i){return rl.dir(i,this+"->_hndSuccess() error","err"),rl.isFunction(n)&&n(t),void this.fireEvent("failure",t)}rl.isFunction(s)&&s(e,t),this.fireEvent("success",e,t)},_hndFailure:function(t){var e=this._requestOptions||{},r=e.failureHandler||this.failureHandler;this._afterRequest(),rl.isFunction(r)&&r(t),this.fireEvent("failure",t)},_hndLoading:function(t){this.fireEvent("loading",t)},_hndError:function(t,e){this._afterRequest(),this.fireEvent("error",t,e)},_hndTimeout:function(){this._transport.abort(),this._afterRequest(),this.fireEvent("timeout")},toString:function(){return"[object rl.rpc.XHRequest]"}}}),rpc.XHRequest.responseHandlers={text:function(t){return t?t.responseText:void 0},xml:function(t){if(t){var e=t.responseXML;if(e)return e.documentElement||e}},json:function(req){if(req)try{return eval("("+req.responseText+")")}catch(e){}}},rl.dom.addEventListener(window,"beforeunload",function(){rl.BEFORE_UNLOAD=!0,setTimeout(function(){rl.BEFORE_UNLOAD=!1},1e3)},null,!1)}(),function(){!function(){var t=rl.rpc;t.IHRequest=rl.createClass({parent:t.AbstractHR,construct:function(t){rl.isPrototyping(arguments[0])||(rl.rpc.IHRequest.parent.call(this,t),this.name||(this.name=rl.autoId()))},members:{responseType:"text",autoDeprecateTransport:!1,abort:function(){return this.requesting&&(this._transport.src=t.URL_BLANK,this._afterRequest(),this.autoDeprecateTransport&&this._deprecateTransport(),this.fireEvent("abort")),this},createTransport:function(){var t=document.createElement("iframe"),e=this.name;t.name=e,t.id=e,rl.IE&&(t.src="javascript:false"),rl.dom.domWarehouse.appendChild(t),rl.IE&&(document.frames[e].name=e),this._transport=t},_sendRequest:function(t,e){if(rl.isNonNullStr(t)){this._transport||this.createTransport();var r=this._transport,s=e._form,n=rl.$(s).isTag("form");n&&(s.action=t,s.target=r.name),rl.dom.addEventListener(r,"load",this._hndLoad,this),this.fireEvent("loading",r),rl.debug(this+" isForm = "+n),n?s.submit():r.src=t}},_deprecateTransport:function(){rl.dom.destroyElements(this._transport),delete this._transport},_hndLoad:function(){if(this.requesting){rl.dom.removeEventListener(s,"load",this._hndLoad,this),this._afterRequest();var t,e,r=this._requestOptions||{},s=this._transport,n=r.successHandler||this.successHandler,i=r.failureHandler||this.failureHandler;try{e=this.getResponseDocument()}catch(o){return rl.isFunction(i)&&i(s),void this.fireEvent("failure",s)}try{t=this.getResponse(r.responseType)}catch(o){return rl.isFunction(i)&&i(s),void this.fireEvent("failure",s)}rl.isFunction(n)&&n(t,e),this.fireEvent("success",t,e),this.autoDeprecateTransport&&this._deprecateTransport()}},_hndTimeout:function(){this._transport.src=t.URL_BLANK,this._afterRequest(),this.autoDeprecateTransport&&this._deprecateTransport(),this.fireEvent("timeout")},getResponse:function(e){var r=this.getResponseDocument();return r?(e=(e||this.responseType).toLowerCase(),t.IHRequest.responseHandlers[e](r)):null},getResponseDocument:function(){if(!this.requesting){var t,e=this._transport;return e?t=rl.IE?e.contentWindow.document:e.contentDocument||window.frames[e.name].document:null}},_initOptions:function(e){var r=e.method||this.method,s=(e.dataType||"").toLowerCase(),n=e.sendData||this.sendData;if(n)if("form"==s||rl.isNonNullStr(n)||rl.isElement(n)&&"form"==n.tagName.toLowerCase()){var i=rl.getDom(n);if(i||(i=document.forms[n]),rl.isElement(i)){rl.isNonNullStr(e.url)||(e.url=i.action||i.getAttribute("action")||this.url);var o=i.getAttribute("enctype");e.mutilpart||o&&"multipart/form-data"==o?(e._form=i,e._form.method="post"):"get"==r?e.url+=(e.url.contains("?")?"&":"?")+rl.data.encodeForm2QS(i):(e._form=i,i.method=i.method||i.getAttribute("method")||"post")}}else("json"==s||rl.isObject(n))&&(e.url=e.url||this.url,n=rl.data.encode2QS(n),"get"==e.method&&(e.url+=(e.url.contains("?")?"&":"?")+rl.data.encode2QS(n)));var a=e.disableCache===!1?!1:this.disableCache;a&&(e.url=t.appendUrlRandom(e.url)),isNaN(e.timeout)&&(e.timeout=this.timeout)},request:function(t){return this.requesting||this.fireEvent("beforerequest",t)===!1?this:(this.requesting=!0,t=this._requestOptions=t||{},this._initOptions(t),rl.dir(t,this+"-> request(): options"),this.timeout>0&&(this._timeoutTimer=Function.delay(this._hndTimeout,1e3*this.timeout,this)),this._sendRequest(t.url,t),this)},reRequest:function(){return this.request(this._requestOptions)},toString:function(){return"[object rl.rpc.IHRequest]"}}})}(),rl.rpc.IHRequest.responseHandlers={json:function(doc){var ele=doc.body,text=ele.innerText||ele.textContent;try{return eval("("+text+")")}catch(e){}},dom:function(t){return t.documentElement||t.body},text:function(t){return(t.documentElement||t.body).innerHTML},xml:function(t){var e=t.XMLDocument;return(e||t).documentElement}}}()});