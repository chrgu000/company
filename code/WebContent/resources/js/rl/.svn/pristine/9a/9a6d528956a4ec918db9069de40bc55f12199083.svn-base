/**
 * @fileOverview GUI Menu.
 * @change
 	#1 by prcjack Creates file.
	#2 by prcjack @2014/05/28 Modify dep "lib.data.XJSON" to "lib.data.engine",
		XJSON is still supported, but you should order it by manual.
	#3 by prcjack @2014/05/29 Merged "gui.menu.MenuItem", "gui.menu.MenuSplit".
	#4 by prcjack @2014/10/02 Remove ctrlPadWidth which make _fit2TextWidth() incorrect.
 */
orderjs.define("gui.menu.Menu",["lib.dom.engine","lib.dom.DomWrap","lib.data.engine","gui.engine","gui.button.Button","css>rl:menu"],function(){!function(){rl.gui.menu.MenuItem=rl.createClass({parent:rl.gui.button.Button,construct:function(t,e,i){rl.isPrototyping(arguments[0])||rl.gui.menu.MenuItem.parent.call(this,t,e,i)},members:{autoRenderOnReady:!1,showNormalStateBorder:!1,_htmlTpl:new rl.HtmlTpl('<TABLE  class="rl_btn rl_menuitem {btnCss} {btnBorderCss}"  title="{tip}" cellSpacing=0 cellPadding=0 border=0><TBODY><TR><TD class="rl_btn_left" ><i>&nbsp;</i></TD><TD class="rl_btn_center btn_txt"><div class="{popupArrowCss}"><button class="{iconCss}" type="{type}" style="{iconBg}">{text}</button></div></TD><TD class="rl_btn_right"><i>&nbsp;</i></TD></TR></TBODY></TABLE>'),initEles:function(){this._ctrlEle=this.dw.dom.getElementsByTagName("button")[0]},initEvents:function(){if(rl.gui.menu.MenuItem.parent.prototype.initEvents.call(this),rl.IE){var t=rl.dw.setTarget(this._ctrlEle);t.on("focus",this.focus,this),t.on("blur",this.blur,this)}},_getTextCtn:function(){return this._ctrlEle},_getIconCtn:function(){return this._ctrlEle},_getWidthExceptCenter:function(){var t=0,e=this.dw.dom;if(e&&e.rows){var i=e.rows[0];i&&Array.each(function(e){if(!rl.$(e).hasClass("btn_txt")){if(rl.dom.QUIRK_TD_OFFSETWIDTH&&"none"==rl.$(e).getStyle("display"))return;t+=e.offsetWidth}},i.cells)}return t},setWidth:function(t){var e=this.dw,i=this.width;return/auto/i.test(t)?t="auto":/%/.test(t)||(t=parseInt(t),t>this.maxWidth?t=this.maxWidth:t<this.minWidth&&(t=this.minWidth)),t==i?this:(this._ctrlEle.style.width="16px",e.setWidth(t),this.width=t,"auto"==t?this._fit2TextWidth():this._fit2CtnWidth(),this)},_updateWidth:function(){/%/.test(this.width)?this._fit2CtnWidth():this._fit2TextWidth()},_fit2TextWidth:function(){var t=(this.dw.dom,this._ctrlEle);if(t)if(""===this.text)rl.dom.addClass(t,"icon_only"),rl.IE&&(t.style.width="");else{rl.dom.removeClass(t,"icon_only");var e=this._getWidthExceptCenter(),i=t.scrollWidth,n=e+i;rl.IE&&(t.style.width=i),this.setWidth(n)}},_fit2CtnWidth:function(){rl.$(this._ctrlEle).setWidth("100%")},toString:function(){return"[object rl.gui.menu.MenuItem]"}}}),rl.gui.ctype2Classes.add("MenuItem",rl.gui.menu.MenuItem)}(),function(){rl.gui.menu.MenuSplit=rl.createClass({parent:rl.gui.ComponentBase,construct:function(t){if(!rl.isPrototyping(arguments[0])){var e=parseInt(t);isNaN(e)?rl.isString(t)&&""==t.trim()&&(this.splitType="blank"):(this.width=e,this.splitType="blank"),rl.gui.menu.MenuSplit.parent.call(this,t),this.dw=new rl.dom.DomWrap,this.autoRenderOnReady&&rl.onReady(Function.bind(this.render,this))}},members:{splitType:"split",width:10,_htmlTpl:new rl.HtmlTpl('<div class="{css}" style="{widthStyle};"><div>'),render:function(t){if(this._rendered)return this;t=this.getRenderTarget(t);var e="";if("blank"==this.splitType){var i=parseInt(this.width);isNaN(i)||(e="width:"+i+"px")}var n=this._htmlTpl.renderTo(t,{widthStyle:e,css:this.splitType+(this.alignRight?" rl_alignright":"")},this.renderPosition);return this.dw.setTarget(n),this._rendered=!0,this},toString:function(){return"[object rl.gui.menu.MenuSplit]"}}}),rl.gui.ctype2Classes.add("MenuSplit",rl.gui.menu.MenuSplit)}(),rl.gui.menu.Menu=rl.createClass({parent:rl.gui.ContainerBase,construct:function(t){rl.isPrototyping(arguments[0])||(rl.gui.menu.Menu.parent.call(this,t),this.initialize())},members:{items:null,itemType:rl.gui.menu.MenuItem,dataSource:void 0,autoRenderOnReady:!0,loadDataBeforeRender:!1,xjsonItemName:"item",width:"auto",iniVisible:!0,TYPE:"Menu",_menuCss:"",zIndex:0,_focusedInMenu:!1,initialize:function(){var t=this.items;this.items=[],this._namedItemsStore={},rl.isArray(t)&&(t=this.initItems(t),this.addItems(t)),rl.isNonNullStr(this.id)||(this.id=this.autoId()),this.dw=new rl.dom.DomWrap,rl.isFunction(this.onInitialize)&&this.onInitialize(),rl.gui.compStore.add(this.id,this),this.autoRenderOnReady&&rl.onReady(Function.bind(this.render,this))},initItems:function(t){var e;if(rl.isArray(t))for(var i=0,n=t.length;n>i;i++)t[i]||t.removeAt(i),i--,n--;return Array.map(function(t){return t instanceof rl.gui.ComponentBase?t:new(e=rl.isObject(t)?this.getItemType(t.ctype):this.itemType)(t)},t,this)},load:function(){var t=this.dataSource;if(rl.data.XJSON&&t instanceof rl.data.XJSON){var e=t.getRoot()[this.xjsonItemName];this._loadingDataForRender=!1,this.loadItemNodes(e)}else rl.debug("Non support dataSource: "+t)},loadFromXjson:function(t){if(!t)return!1;var e=t.getRoot()[this.xjsonItemName];this.loadItemNodes(e)},loadItemNodes:function(t){var e=[],i=Function.bind(function(t){var i=this.loadItemNode(t);i&&e.push(i)},this);rl.isArray(t)?Array.each(i,t):i(t),this.addItems(e),this.render()},loadItemNode:function(t){if(!t)return null;var e,i,n,s,r=(this.itemType,this.xjsonItemName);if(s=t["@attributes"]||t,i=this.getItemType(s.ctype),n=t[r],rl.isObject(n)){var o,u,d=t.popup||{};d=d["@attributes"]||d,d.autoRenderOnReady=!1,d.loadDataBeforeRender=!1,o=rl.gui[s.popupType||d.type]||rl.gui.menu.PopupMenu,u=new o(d),u.loadItemNodes(n),s.popup=u}return e=new i(s)},_htmlTpl:new rl.HtmlTpl('<div class="rl_comp rl_menu {css}" id="{id}" style="width:{width}; visibility:{visibility}"></div>'),render:function(t){if(this.loadDataBeforeRender)return this.loadDataBeforeRender=!1,this._loadingDataForRender=!0,this.load(),this;if(this._loadingDataForRender)return this;if(this._rendered)return this;t=this.getRenderTarget(t);var e=this._htmlTpl.renderTo(t,{id:this.id,css:this._menuCss,visibility:this.iniVisible?"":"hidden",width:rl.dom.addUnit(this.width)},this.renderPosition);return this.dw.setTarget(e),this.dw.on("contextmenu",this.hndContextmenu,this),rl.gui.makeUnselectable(e,!0),this._renderItems(),this._rendered=!0,this.fireEvent("render"),this},afterAdd:function(t,e,i){var n=t.owner;if(n instanceof rl.gui.ContainerBase&&rl.isFunction(n.remove)&&n.remove(t),t.owner=this,this._rendered){var s,r=this._getItemsCtn();if(i>-1){var o=this.items[i+1];o._rendered&&(r=o.dw.dom,s="beforebegin")}rl.debug("where = "+s),t.appendDomTo(r,s)}},_getItemsCtn:function(){return this.dw.dom},afterRemove:function(t){delete t.owner,t.removeDom()},_renderItems:function(){Array.each(this._renderItem,this.items,this)},_renderItem:function(t){t.appendDomTo(this._getItemsCtn())},show:function(){this.dw.removeClass("rl_hidden")},hide:function(){this.dw.addClass("rl_hidden")},showItemPopup:function(t){if(this.items.contains(t)){t.focus();var e=t.popup;if(!e)return void(this._showingSubPopup&&"PopupMenu"==this.TYPE&&(this._showingSubPopup.hide(),this._showingSubPopup=null));if(rl.isFunction(e.showAt)&&this._showingSubPopup!=e){this._showingSubPopup&&this._showingSubPopup.hide(),this._showingSubPopup=e,e.parentMenu=this,this._focusedInMenu=!0;var i="PopupMenu"==this.TYPE?"eb":"be",n=this.dw.getZIndex();n>=e.dw.getZIndex()&&e.dw.setZIndex(n+1),e.dw.alignTo(t.dw,i,!0),e.show()}}},afterSubPopupHide:function(){this._focusedInMenu=!1,this._showingSubPopup=null},hndItemActionEvent:function(t,e){if(e.action)return rl.isFunction(e.action)||rl.isNonNullStr(e.action),void rl.gui.popupMgr.hideAllPopup();var i=e.actionData;rl.isFunction(this.action)&&!rl.isEmpty(i)?(this.action(i,e),rl.gui.popupMgr.hideAllPopup()):this.parentMenu&&rl.isFunction(this.parentMenu.hndItemActionEvent)&&this.parentMenu.hndItemActionEvent(t,e)},hndItemMousedown:function(t,e){if(this.items.contains(t)){var i=this.TYPE;rl.ew.init(e).stopBubble(),Function.defer(function(){("StandardMenu"==i||"ToolBar"==i)&&("StandardMenu"==i&&(this._focusedInMenu=!0),this.showItemPopup(t))},this)}},hndContextmenu:function(t){rl.gui.autoStopContextmenu(t)},hndItemMouseover:function(t,e){if(this.items.contains(e)){var i=this.TYPE;("PopupMenu"==i||this._focusedInMenu)&&this.showItemPopup(e)}},doAction:function(){},onDispose:function(){try{Array.invoke("dispose",this.items)}catch(t){rl.dir(t,this+" -> onDispose(): Item dispose error")}delete this.items,delete this._namedItemsStore,this.dw.dispose(),delete this.dw},toString:function(){return"[object rl.gui.menu.Menu]"}}}),rl.gui.ctype2Classes.add("Menu",rl.gui.menu.Menu),rl.data.XJSON&&rl.data.XJSON.regCaseConverts("menu",{actiondata:"actionData"})});