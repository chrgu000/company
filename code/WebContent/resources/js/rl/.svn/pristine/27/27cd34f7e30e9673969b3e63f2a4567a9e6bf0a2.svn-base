orderjs.define("gui.form.TreeSelect",["lib.data.Table","lib.data.XJSON","gui.engine","gui.button.IconButton","gui.form.Input","gui.tree.Tree","css>rl:inputs"],function(){rl.gui.form.TreeSelect=rl.createClass({parent:rl.gui.form.Input,construct:function(t){rl.isPrototyping(arguments[0])||rl.gui.form.TreeSelect.parent.call(this,t)},members:{multiple:!0,value:"",text:"",iniShowClearer:!1,autoShowClearer:!0,ctrlExtras:"",treeOptions:null,popup:null,tree:null,_extraCtrlsWidth:30,_treeReady:!1,_interactiveStateCssPrefix:"rl_ctm_input_",_interactiveMouseTypes:["out","over"],_htmlTpl:new rl.HtmlTpl('<span id="{id}" class="rl_comp rl_input rl_ctm_input rl_treeselect {css}" title="{tip}"><label for="{ctrlId}" class="{labelCss}">{label}</label><span class="wrapper" id="{wrapperId}"><input id="{valueCtrlId}" value="{value}" type="hidden" name="{name}" {ctrlExtras} /><input id="{ctrlId}" class="{ctrlCss}" value="{text}" readonly="readonly" {disabledState} /><img class="clearer" style="border:none; visibility:hidden;" id="{clearerId}" src="'+rl.gui.URL_BLANK_IMG+'" /><span id="{popupCtrlId}"></span></span></span>'),initialize:function(){this.dw=new rl.dom.DomWrap,rl.isNonNullStr(this.id)||(this.id=this.autoId());var t=this.id;this.ctrlId=t+"_ctrl",this.valueCtrlId=t+"_valueCtrl",this.wrapperId=t+"_wrapper",this.clearerId=t+"_clearer",this.popupCtrlId=t+"_popupCtrl",rl.gui.compStore.add(this.id,this),this.initTree(),this.autoRenderOnReady&&rl.onReady(Function.bind(this.render,this))},render:function(t){if(this._rendered)return this;t=this.getRenderTarget(t);var e,i=this.disabled?" disabled='disabled' ":"";return disabledState=this.editable?"":"readonly='readonly'",e=this._htmlTpl.renderTo(t,{css:this.css+(this.alignRight?" rl_alignright":""),labelCss:this.labelCss,ctrlCss:this.ctrlCss,id:this.id,ctrlId:this.ctrlId,valueCtrlId:this.valueCtrlId,wrapperId:this.wrapperId,clearerId:this.clearerId,popupCtrlId:this.popupCtrlId,label:this.label,tip:this.tip,name:this.name,value:this.value,text:this.text,ctrlExtras:this.ctrlExtras,disabledState:disabledState,readonlyState:i},this.renderPosition),this.dw.setTarget(e),e=null,this.initView(),this._rendered=!0,this.fireEvent("render"),this},setValue:rl.gui.FN_ReturnThis,getValue:function(){return this.value},disable:function(){return this.disabled?this:(this.disabled=!0,this._ctrlEle&&(this._ctrlEle.disabled=!0),this.displayStateChangedStyle(),rl.isNonNullStr(this.disabledIcon)&&this._updateIconView(this.disabledIcon),this.popupCtrl.disable(),this)},enable:function(){return this.disabled?(this.disabled=!1,this._ctrlEle&&(this._ctrlEle.disabled=!1),this.displayStateChangedStyle(),rl.isNonNullStr(this.disabledIcon)&&this._updateIconView(this.getIcon()),this.popupCtrl.enable(),this):this},setWidth:function(t){var e=this.width;if(t===e)return this;var i=this.dw.dom;if(rl.isElement(i)){var r=t;if(rl.isNumber(r)||(/%/.test(r)?r=rl.$(i.parentNode).getWidth():/auto/.test(r)||(r=parseInt(r))),rl.isNumber(r)){var s=r-this._extraCtrlsWidth;rl.$(this.ctrlId).setWidth(s)}}return this.width=t,this.fireEvent("widthchange",t,e),this},clear:function(){return this._treeReady?this.multiple?this.tree.unSelectAll():this.tree.setSingleSelected():(this.value=this._valueCtrlEle.value=this._ctrlEle.value=this._ctrlEle.title="",this.hideClearer()),this},showClearer:function(){rl.$(this.clearerId).setStyle("visibility: inherit;")},hideClearer:function(){rl.$(this.clearerId).setStyle("visibility: hidden;")},checkClearerDisplay:function(){var t=String(this.value);0==t.length?this.hideClearer():this.showClearer()},showPopup:function(){if(this.popup.hidden){var t=this.popup;this._treeReady?t.setTarget(this.tree):this.initTreeView(),t.show()}},hidePopup:function(){this.popup.hide()},deferShowPopup:function(){Function.defer(this.showPopup,this)},initTree:function(){var t=this.tree;if(!t){var e=rl.ext({autoRenderOnReady:!1,showIcons:!1,deferRenderNodes:!1,orderBranchesFirst:!1,width:200,height:200},this.treeOptions);e.selectorType=this.multiple?"multi":"single",t=this.tree=new rl.gui.tree.Tree(e),t.on("selectchange",this.hndTreeSelectChange,this)}},initView:function(){this.initCtrl(),rl.dom.STEADY_INLINE_HEIGHT||rl.$(this.wrapperId).addClass("wrapper_inline_hack"),this.initEvents(),this.initExtraCtrls(),this.initSize(),this.initTreeView(),this.updateValueListener()},initEvents:function(){var t,e,i=this.dw;rl.IE?(t="focusin",e="focusout"):(t="focus",e="blur"),i.on(t,this.hndFocus,this,!0),i.on(e,this.hndBlur,this,!0),i.on("mouseover",this.hndMouseover,this),i.on("mouseout",this.hndMouseout,this),i.on("mousedown",this.hndMousedown,this)},initTreeView:function(){var t=this.tree;if(!t._rendered){t.render(),t.dw.hide(),this._treeReady=!0;var e=this.value;if(rl.isNonNullStr(e)){var i=e=e.trim();if(this.multiple){var r=this.value.split(",");i=r[0],t.selectThese.apply(t,r)}else t.selectThese(e);t.openTo(i)}}},initCtrl:function(){this._ctrlEle=rl.$(this.ctrlId).dom,this._valueCtrlEle=rl.$(this.valueCtrlId).dom},initExtraCtrls:function(){this.autoShowClearer&&this.initClearer(),this.initPopupCtrl(),this.initPopup()},initClearer:function(){var t=rl.$(this.clearerId);t.on("mouseover",this.hndClearerMouseover,this),t.on("mouseout",this.hndClearerMouseout,this),t.on("mousedown",this.hndClearerMousedown,this),this.on("change",this.checkClearerDisplay,this),this.iniShowClearer&&this.checkClearerDisplay()},initPopupCtrl:function(){this.popupCtrl=new rl.gui.button.IconButton({_sizeCss:"actionctrl",renderTarget:this.popupCtrlId,icon:rl.gui.mapImg("inputs/arrow_down.gif"),disabledIcon:rl.gui.mapImg("inputs/arrow_down_disabled.gif"),action:Function.bind(this.showPopup,this)})},initPopup:function(){this.popup=new rl.gui.PopupWrap({owner:this})},initSize:function(){var t=this.width;delete this.width,this.width=void 0,this.setWidth(t)},hndTreeSelectChange:function(){var t,e="",i=this.tree;if(this.multiple){var r=i.getSelectedNodes(),s=[],l=[];Array.each(function(t){l.push(t.text),s.push(t.id)},r),rl.debug(this+" nodes.length = "+r.length),e=l.join(", "),t=s.join(","),rl.debug(this+" text = "+e),rl.debug(this+" value = "+t)}else{var n=i.getSelectedNode();n?(e=n.text,t=n.id):e=t=""}this._valueCtrlEle.value=this.value=t,this._ctrlEle.value=this._ctrlEle.title=e,this.updateValueListener(),this.fireEvent("change")},hndFocus:function(){this.disabled||(this.focused=!0,this.applyInteractiveStyle("out"),this.deferShowPopup())},hndBlur:function(){this.disabled||(this.focused=!1,this.applyInteractiveStyle("out"))},hndMouseover:function(){this.disabled||this.applyInteractiveStyle("over")},hndMouseout:function(){this.disabled||this.applyInteractiveStyle("out")},hndMousedown:function(t){var e=rl.ew.init(t),i=e.getTarget();i.id==this.wrapperId&&rl.getDom(this.ctrlId).focus()},hndClick:function(){},hndClearerMouseover:function(){rl.$(this.clearerId).addClass("clearer_bg_over")},hndClearerMouseout:function(){rl.$(this.clearerId).removeClass("clearer_bg_over")},hndClearerMousedown:function(){this.clear()},_getInteractiveStateCss:function(t){if(rl.isNonNullStr(t)&&(t=t.toLowerCase(),this._interactiveMouseTypes.contains(t))){var e=this._interactiveStateCssPrefix;return this.disabled?e+="disabled":this.focused?e+="focused":"out"==t?e="":e+=t,e}},toString:function(){return"[object rl.gui.form.TreeSelect]"}}}),rl.gui.ctype2Classes.add("TreeSelect",rl.gui.form.TreeSelect)});