orderjs.define("gui.tree.Tree",["lib.data.Table","lib.data.XJSON","lib.rpc.engine","gui.engine","gui.tree.Node","gui.tree.RootNode","css>rl:tree"],function(){rl.gui.tree.Tree=rl.createClass({parent:rl.gui.ContainerBase,construct:function(e){rl.isPrototyping(arguments[0])||(rl.gui.tree.Tree.parent.call(this,e),this.dw=new rl.DomWrap,rl.isNonNullStr(this.id)||(this.id=this.autoId()),rl.gui.compStore.add(this.id,this),this.initialize())},members:{iniOpenTo:"",autoOpenToFirst:!0,autoExpand:!0,branchNodeBehaviour:"toggle",dataSource:null,loadDataBeforeRender:!0,autoRenderOnReady:!0,deferRenderNodes:!0,lazyRender:!1,showIcons:!0,selectorType:"none",branchesSelectable:!1,trackBlank:!1,URIActionData:!0,width:"100%",height:"100%",actionEventName:"click",xjsonItemName:"item",xjsonUrl:"",nodeType:rl.gui.tree.Node,rootNodeType:rl.gui.tree.RootNode,blankImg:rl.gui.URL_BLANK_IMG,treeCss:"",iconRoot:"",defaultLeafIcon:rl.gui.imgPM.mapping("tree/leaf.gif"),defaultBranchIcon:rl.gui.imgPM.mapping("tree/folder.gif"),defaultOpenedBranchIcon:rl.gui.imgPM.mapping("tree/folder_open.gif"),showElbowLines:!0,cssElbowWithLines:"rl_tree_lines",cssElbowNoLines:"rl_tree_no_lines",orderBranchesFirst:!0,MSG_READ_DATA_ERR:rl.getG11nSource("READ_DATA_ERR")||"Read data error",_htmlTpl:new rl.HtmlTpl('<div id={id} class="rl_tree {css} {linesStyle}" style="width:{width}; height:{height};"></div>'),initialize:function(){this.rootNode=new this.rootNodeType({id:this.id+"_root",xjsonItemName:this.xjsonItemName,ownerComp:this,tree:this}),this.autoRenderOnReady&&rl.onReady(Function.bind(this.render,this))},render:function(e){if(this.initDataSource(),this.loadDataBeforeRender)return this.loadDataBeforeRender=!1,this._loadingDataForRender=!0,this.load(),this;if(this._loadingDataForRender)return this;if(this._rendered)return this;e=this.getRenderTarget(e);var t=rl.dom.insertHtml(this.renderPosition,this.getRenderHtml(),e);return this.dw.setTarget(t),this._rendered=!0,this.afterRender(),this.fireEvent("render"),this},getRenderHtml:function(){var e=this.showElbowLines?this.cssElbowWithLines:this.cssElbowNoLines,t=this.id,i=rl.isNonNullStr(this.css)||"",n=rl.dom.addUnit(this.width),o=rl.dom.addUnit(this.height);return this._htmlTpl.assign({id:t,css:i,width:n,height:o,linesStyle:e})},getRootNodeCtn:function(){return this.dw.dom},initEvents:function(){var e=this.dw;e.on(this.actionEventName,this.hndActionEvent,this),e.on("dblclick",this.hndDblclick,this)},initFirstOpenTo:function(){var e,t=this.rootNode.firstChild;rl.isNonNullStr(this.iniOpenTo)&&(e=this.rootNode.findByIdInAll(this.iniOpenTo)),!e&&this.autoOpenToFirst&&(e=t),e?(this.openTo(e),this.autoExpand&&e.expand()):this.autoExpand&&t&&t.expand()},initDataSource:function(){if(this.dataSourceInited)return this;var e=this.dataSource;!e&&rl.isNonNullStr(this.xjsonUrl)?this.initXjsonDataSource():rl.data.XJSON&&e instanceof rl.data.XJSON||(e.on("load",this.hndDataLoad,this),e.on("readrequesterror",this.hndDataReadErr,this)),this.dataSourceInited=!0},initXjsonDataSource:function(){var e=new rl.rpc.XHRequest({url:this.xjsonUrl,responseType:"xml",method:"get",async:!1,successHandler:Function.bind(this.hndXjsonDataLoadSuccess,this),failureHandler:Function.bind(this.hndXjsonDataLoadFailure,this)});e.request()},hndXjsonDataLoadSuccess:function(e){this.dataSource=rl.toXjson(e)},hndXjsonDataLoadFailure:function(){},hndActionEvent:function(e){var t=rl.ew.init(e).getTarget(),i=this.getNodeByEvent(e);i&&i.doAction(t)},hndDblclick:function(e){var t=rl.ew.init(e).getTarget(),i=this.getNodeByEvent(e);if(i){if(!this.trackBlank&&i.isBlankArea(t))return;i.hasChildren()&&(this.branchNodeBehaviour.equalsIgnoreCase("toggle")?i.toggleCollapse():i.expand())}},afterChildFocus:function(e){e&&e!=this.rootNode&&(this._lastFocusedNode&&this._lastFocusedNode.blur(),this._lastFocusedNode=e)},getScrollWidth:function(){return this.dw.dom.firstChild.scrollWidth},getOffsetWidth:function(){return this.dw.dom.firstChild.offsetWidth},openTo:function(e){return rl.isNonNullStr(e)&&(e=this.rootNode.findByIdInAll(e)),e&&this.rootNode.openTo(e),e},filterViewBy:function(e,t){"multi"!==this.selectorType&&(this.firstFoundChild=null,this.rootNode.filterChildrenViewBy(e,t),this.rootNode._delayUpdateView(),this.openTo(this.firstFoundChild))},getNodeByEvent:function(e){var t=this.getNodeEleByEvent(e);return this.getNodeByNodeEle(t)},getNodeByNodeEle:function(e){return this.rootNode.getNodeFromNodeEle(e)},getNodeEleByEvent:function(e){var t=rl.ew.init(e).getTarget();return rl.dom.findParentBy(t,this._isNodeEle,this)},getNodeEleByChild:function(e){return rl.dom.findParentBy(e,this._isNodeEle,this)},getSelectedNodes:function(){if("multi"!==this.selectorType)return[];var e=[],t=this.rootNode;return Array.each(function(t){t.selected&&e.push(t),t.hasChildren()&&t.each(arguments.callee)},t.childNodes,this),e},getSelectedIdList:function(){var e=this.getSelectedNodes(),t=Array.map(function(e){return e.id},e);return t.join(",")},getSelectedNode:function(){return"single"===this.selectorType?this._singleSelectedNode:void 0},setSingleSelected:function(e){var t=this._singleSelectedNode;t!==e&&(this._singleSelectedNode=e,this.fireEvent("selectchange"))},selectThese:function(e){e&&("multi"===this.selectorType?Array.each(this._selectOneOfMulti,arguments,this):"single"===this.selectorType&&(rl.isNonNullStr(e)&&(e=this.rootNode.findByIdInAll(e)),this.setSingleSelected(e)),this.fireEvent("selectchange"))},_selectOneOfMulti:function(e){rl.isNonNullStr(e)&&(e=this.rootNode.findByIdInAll(e)),e&&e.select()},selectAll:function(){this.rootNode.selectAll(),this.fireEvent("selectchange")},unSelectAll:function(){this.rootNode.unSelectAll(),this.fireEvent("selectchange")},hndNodesSelectChange:function(){this.fireEvent("selectchange")},afterNodeEndBatchSelect:function(){this.updateCheckboxStatus(this.rootNode)},initNodesCheckboxStatus:function(){this.updateCheckboxStatus(this.rootNode)},updateCheckboxStatus:function(e){if(e.hasChildren()){var t;if(e.each(function(e){(e.selected||this.updateCheckboxStatus(e))&&(t=!0)},this),t&&!e.selected)return e._updateSelectorView(),!0}},_isNodeEle:function(e){try{var t=e.id,i=rl.dw.setTarget(e);return t&&i.hasClass("node")&&i.isTag("li")}catch(n){}},load:function(e){var t=this.dataSource;if(rl.data.XJSON&&t instanceof rl.data.XJSON){var i=t.getRoot(),n=i["@attributes"],o=i[this.xjsonItemName];n&&(rl.isNonNullStr(this.iconRoot)||(this.iconRoot=n.iconRoot),this.iniOpenTo||(this.iniOpenTo=n.iniOpenTo)),this.rootNode.loadItemNodes(o),this._loadingDataForRender=!1,this.render()}else t.load(e)},hndDataLoad:function(){this.rootNode.load(),this._rendered?(this.rootNode.reRender(this.getRootNodeCtn()),this.initNodesCheckboxStatus()):(this._loadingDataForRender=!1,this.render())},hndDataReadErr:function(e){var t=this.readDataErrHandler||rl.gui.tree.gridReadDataErrHandler;if(!rl.isFunction(t)||t.call(this,e)!==!1){var i=(e||rl.EMPTY_OBJECT).description||"";rl.dir(e),rl.BEFORE_UNLOAD||alert(i)}},afterRender:function(){this.initEvents(),this.rootNode.renderTarget=this.getRootNodeCtn(),this.deferRenderNodes?Function.defer(this.renderRoot,this):this.renderRoot()},renderRoot:function(){this.rootNode.render(),this.orderBranchesFirst&&this.rootNode._sortChildNodes(),Function.defer(function(){this.initFirstOpenTo(),this.initNodesCheckboxStatus()},this)},createNode:function(e){var t;return t=new this.nodeType(rl.ext({ownerComp:this,xjsonItemName:this.xjsonItemName},e))},setHeight:function(e){this.dw.setHeight(e),rl.VER_IE>0&&rl.VER_IE<7&&this.rootNode.setHeight(e-19)},toString:function(){return"[object rl.gui.tree.Tree]"}}}),rl.Tree=rl.gui.tree.Tree,rl.gui.ctype2Classes.add("Tree",rl.gui.tree.Tree),rl.data.XJSON.regCaseConverts("tree",{iconroot:"iconRoot",branchicon:"branchIcon",openedbranchicon:"openedBranchIcon",iniopento:"iniOpenTo",actiondata:"actionData"})});