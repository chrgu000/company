orderjs.define("gui.CalendarView",["lib.data.Calendar","gui.engine","css>rl:calendar_view"],function(){rl.gui.CalendarView=rl.createClass({parent:rl.gui.ComponentBase,construct:function(e){rl.isPrototyping(arguments[0])||(rl.gui.CalendarView.parent.call(this,e),this.initialize())},members:{dataSource:null,dayNameRenderer:null,dayRenderer:null,monthRenderer:null,yearRenderer:null,hiliteWeekend:!0,hiddenDays:null,autoRenderOnReady:!1,width:"100%",height:"100%",_navStep:Date.MONTH,_htmlTpl:new rl.HtmlTpl('<div class="rl_calendar" id="{id}"><table class="head" cellspacing="0" cellpadding="0"><tr><td class="ymctrl_ctn"><a href="#" hidefocus="true" id="{ymctrlId}"></a></td><td class="navbar" id="{navbarId}"></td></tr></table><div class="body"><div id="{dayPaneId}" class="day_pane"><table class="daynames_ctn"  cellspacing="0" cellpadding="0">{dayNameGrid}</table><table class="daylist_ctn"  cellspacing="0" cellpadding="0">{dayGrid}</table></div></div></div>'),initialize:function(){this.dw=new rl.dom.DomWrap,this.initDataSource(),this._yearPaneYears=this._getYearPaneYears(),rl.isNonNullStr(this.id)||(this.id=this.autoId());var e=this.id;this.ymctrlId=e+"_ymbar",this.navbarId=e+"_navbar",this.dayPaneId=e+"_dayListCtn",rl.gui.compStore.add(this.id,this),this.autoRenderOnReady&&rl.onReady(Function.bind(this.render,this))},initDataSource:function(){this.dataSource||(this.dataSource=new rl.data.Calendar);var e=this.dataSource;return e.on("monthchange",this.hndDataMonthChange,this),e.on("yearchange",this.hndDataYearChange,this),e},render:function(e){if(this._rendered)return this;e=this.getRenderTarget(e);{var t;rl.dom.addUnit}return t=this._htmlTpl.renderTo(e,{id:this.id,ymctrlId:this.ymctrlId,navbarId:this.navbarId,dayPaneId:this.dayPaneId,dayNameGrid:this.createDayNameGrid(),dayGrid:this.createDayGrid()},this.renderPosition),this.dw.setTarget(t),this.initEles(),this.updateDayNameCells(),this.updateDayCells(),this.updateYMCtrl(),this._rendered=!0,this.fireEvent("render"),this},initEles:function(){var e=rl.getDom(this.dayPaneId),t=e.firstChild,a=t.nextSibling;this.dayNameCells=t.getElementsByTagName("th"),this.dayCells=a.getElementsByTagName("td")},createDayNameGrid:function(){return this._createGrid(1,7,!0)},createDayGrid:function(){return this._createGrid(6,7)},createYearGrid:function(){return this._createGrid(3,4)},createMonthGrid:function(){return this._createGrid(3,4)},_createGrid:function(e,t,a){var i="<td></td>";a&&(i=i.replace("td","th"));var r=i.times(t);return("<tr>"+r+"</tr>").times(e)},updateDayNameCells:function(){Array.each(this._updateDayNameCell,this.dayNameCells,this)},_updateDayNameCell:function(e,t){e.innerHTML=this._getDayNameCellViewDetail(t).content},_getDayNameCellViewDetail:function(e){var t;return e+=this.dataSource.startDay,e>=7&&(e-=7),t=Date.getShortDayName(e),rl.isFunction(this.dayNameRenderer)&&(t=this.dayNameRenderer(t)),{content:t}},updateDayCells:function(){this.dataSource.mapDays(this._updateDayCell,this)},_updateDayCell:function(e,t,a){var i=this._getDayCellViewDetail(e,t,a),r=this.dayCells[e];r&&i&&(r.innerHTML=i.content,r.className=i.css)},_getDayCellViewDetail:function(e,t,a){var i,r=this.dayRenderer,n=this.dataSource,l="",s=0!==a.posFlag;return i=rl.isFunction(r)?r(e,t,a,this):t,s?l+=" cell_extra":(a.isToday&&(l+=" cell_today"),n.getDate()===t&&(l+=" cell_selected")),{content:i,css:l}},updateMonthCells:function(){Array.each(this._updateMonthCell,this.monthCells,this)},_updateMonthCell:function(e,t){var a=this._getMonthCellViewDetail(t);e.innerHTML=a.content,e.className=a.css},_getMonthCellViewDetail:function(e){var t,a="";return t=Date.getShortMonthName(e),rl.isFunction(this.monthRenderer)&&(t=this.monthRenderer(t)),this.dataSource.getMonth()===e&&(a+=" cell_selected"),{content:t,dateValue:e,css:a}},updateYearCells:function(){Array.each(this._updateYearCell,this.yearCells,this)},_updateYearCell:function(e,t){var a=this._getYearViewDetail(t);e.innerHTML=a.content,e.className=a.css},_getYearViewDetail:function(e){var t,a,i=this._yearPaneYears,r="";return t=a=i+e+(i>-1?-1:1),1>a&&(t=a-1),rl.isFunction(this.yearRenderer)&&(t=this.yearRenderer(t)),-10===i&&a>0||0===i&&1>a?r+=" cell_extra":(0===e||11===e)&&(r+=" cell_extra"),this.dataSource.getFullYear()===a&&(r+=" cell_selected"),{content:t,dateValue:a,css:r}},updateYMCtrl:function(){var e=this.dataSource,t=e.getFullYear()+"-"+(e.getMonth()+1);rl.getDom(this.ymctrlId).innerHTML=t},hndDataMonthChange:function(){this._rendered&&(this.updateDayCells(),this.updateYMCtrl(),this._ymPaneVisible&&this.updateMonthCells())},hndDataYearChange:function(){this._yearPaneYears=this._getYearPaneYears(),this._ymPaneVisible&&this.updateYearCells()},_getYearPaneYears:function(){var e=this.dataSource.getFullYear();return 1>e&&(e-=2),10*Math.floor(e/10)},onDispose:function(){delete this.dayNameCells,delete this.dayCells,delete this.monthCells,delete this.yearCells,this.dw.dispose(),delete this.dw,this.clearAllEvents()},toString:function(){return"[object rl.gui.CalendarView]"}}}),rl.gui.ctype2Classes.add("CalendarView",rl.gui.CalendarView)});