orderjs.define("lib.rpc.SdtHelper",["lib.dom.engine","lib.rpc.engine"],function(){rl.rpc.SdtHelper=rl.createClass({parent:rl.util.EventProvider,construct:function(t){rl.isPrototyping(arguments[0])||(rl.rpc.SdtHelper.parent.call(this,t),rl.ext(this,t),this.initialize())},members:{onSuccess:null,onFailure:null,onLoading:null,onComplete:null,onRequestStateChange:null,url:void 0,async:!0,method:"get",multipart:!1,sendData:null,expectRspType:"xml",httpRequest:null,requestState:0,status:0,_filteredRequestOptionFields:["onLoading","onComplete","onSuccess","onFailure","onError","onRequestStateChange"],initialize:function(){this.initHttpRequest()},initHttpRequest:function(){this.httpRequest||(this.httpRequest=this.createHttpRequest());var t=this.httpRequest;if(!(t instanceof rl.rpc.AbstractHR))throw{description:this+"->initialize(): Invalid httpRequest!"};var e=rl.rpc.sdtStatuses;t.on("loading",Function.bind(this._updateRequestState,this,"loading")),t.on("failure",Function.bind(this.hndExceptionRequest,this,e.REQUEST_FAILURE)),t.on("timeout",Function.bind(this.hndExceptionRequest,this,e.REQUEST_TIMEOUT)),t.on("abort",Function.bind(this.hndExceptionRequest,this,e.REQUEST_ABORT)),t.on("success",this.hndSuccessRequest,this)},createHttpRequest:function(){var t,e=this.multipart;return e&&(this.aysnc=!0),t=e?"IHRequest":"XHRequest",new rl.rpc[t]({url:this.url,responseType:this.expectRspType,disableCache:!0,async:this.async,method:this.method,multipart:e,autoDeprecateTransport:!0,sendData:this.sendData})},request:function(t){return this.isRequesting()?this:(this._requestOptions=t,this._prepareRequest(),this.httpRequest.request(this._getFilteredRequestOptions(t)),this)},reRequest:function(){return this.httpRequest.reRequest(),this},isRequesting:function(){return this.httpRequest.requesting},abort:function(){return this.httpRequest.abort(),this},hndSuccessRequest:function(t,e){var s,r,i,n=rl.rpc,u=n.readSdtRsp(t,e,this.expectRspType);u?(s=parseFloat(u.status),r=u.msg||n.sdtStatusMessages[u.status],i=u.data):(s=n.sdtStatuses.SERVER_ERROR,r=n.sdtStatusMessages[s]),this.rspData=i,this.hndRequestComplete(s,r,i)},hndExceptionRequest:function(t){this.hndRequestComplete(t)},hndRequestComplete:function(t,e,s){var r,i,n=rl.rpc;e||(e=n.sdtStatusMessages[t]),this.status=t,this.rspMsg=e,this._updateRequestState("complete",t,e,s),r=this.isOk()?"success":"failure",i=this._getCfgRequestEventHandler("on"+r.capitalize()),rl.isFunction(i)&&i.call(this,t,e,s),this.fireEvent(r,t,e,s),this.requestState=rl.rpc.sdtRequestStates.READY},_updateRequestState:function(t,e,s,r){var i=rl.rpc,n=i.sdtRequestStates[t.toUpperCase()];if(n!=this.requestState){var u=this._getCfgRequestEventHandler("on"+t.capitalize()),a=this._getCfgRequestEventHandler("onRequestStateChange");this.requestState=n,rl.isFunction(u)&&u.call(this,e,s,r),this.fireEvent(t,e,s,r),rl.isFunction(a)&&a.call(this,this.requestState,e,s,r),this.fireEvent("RequestStateChange",this.requestState,e,s,r)}},isOk:function(){var t=this.status;return t>=1&&2>t},_getCfgRequestEventHandler:function(t){var e=this._requestOptions||{};return e[t]||this[t]},_getFilteredRequestOptions:function(t){var e={},s=this._filteredRequestOptionFields;for(var r in t)s.contains(r)||(e[r]=t[r]);return e},_prepareRequest:function(){this.status=0,delete this.rspMsg,delete this.rspData},toString:function(){return"[object rl.rpc.SdtHelper]"}}}),rl.ext(rl.rpc,{SDT_HTML_RESPONSE_ROOT_ID:"SDT_RESPONSE_ROOT",sdtStatuses:{LOAD_SUCCESS:1,OK:1,REQUEST_FAILURE:2,CONNECT_FAILURE:2.01,REQUEST_ABORT:2.02,REQUEST_TIMEOUT:2.03,NOT_FOUND:2.04,ACCESS_FAILURE:2.1,SESSION_TIMEOUT:2.11,UNAUTHORIZED:2.12,FORBIDDEN:2.13,SERVER_ERROR:3,NOT_IMPLEMENTED:3.01,SERVICE_UNAVAILABLE:3.02},sdtRequestStates:{READY:0,LOADING:1,COMPLETE:2},sdtStatusMessages:function(){var t=rl.getG11nSource("rl.rpc.sdtStatusMessages");return rl.ext({1:"Load success.",2:"Request failure.",2.01:"Connect failure.",2.02:"Request aborted.",2.03:"Request timeout.",2.04:"Not found.","2.10":"Access failure.",2.11:"Session timeout.",2.12:"Unauthorized.",2.13:"Forbidden.",3:"Internal server error.",3.01:"Not implemented.",3.02:"Service unavailable."},t)}(),isSdtOk:function(t){return t>=1&&2>t},stripSdtRspMeta:function(t){if(rl.isNonNullStr(t)){var e=new RegExp("<meta[^>]+id\\s*=[^>]+"+rl.rpc.SDT_HTML_RESPONSE_ROOT_ID+".*?(?:\\/>|<\\/meta\\s*>)","i");return t.replace(e,"")}},readSdtRsp:function(t,e,s){var r,i=rl.rpc;if(s=rl.isNonNullStr(s)?s.toLowerCase():"text",t&&("xml"==s?r=i.readNodeChildren(t):rl.isObject(t)&&"json"==s&&(r=t)),e&&(!r||rl.isEmpty(r.status)))if("undefined"!=typeof e.getElementById)r=i.readSdtRspInDocument(e);else if(rl.isDefined(e.responseText)){var n=e.responseText,u=String.stripScripts(n),a=rl.dom.createElements("<iframe src=''></iframe"),l=a.contentWindow.document;l.write(u),r=i.readSdtRspInDocument(l,n)}return r},readSdtRspInDocument:function(t,e){var s,r=rl.rpc,i=t.getElementById(r.SDT_HTML_RESPONSE_ROOT_ID);if(i)if(i.hasChildNodes()){var n=i.XMLDocument;n?s=r.readNodeChildren(n.documentElement):Array.some(function(t){return rl.isElement(t)?(s=r.readNodeChildren(t),!0):void 0},i.childNodes)}else{var u=rl.isNonNullStr(e)?rl.rpc.stripSdtRspMeta(e):t.body.innerHTML;s={status:r.sdtStatuses.LOAD_SUCCESS,data:u}}return s},readNodeChildren:function(t,e){if(!t||1!=t.nodeType||"undefined"==typeof t.hasChildNodes||!t.hasChildNodes())return null;var s,r,i,n=rl.rpc,u={},a={};return Array.each(function(t){1===t.nodeType&&(i=t.firstChild,r=t.tagName.toLowerCase(),s=i&&i==t.lastChild&&3===i.nodeType?i.nodeValue:e?t:n.readNodeChildren(t,!0),u[r]?(rl.isArray(a[r])||(a[r]=[s]),a[r].push(s)):(a[r]=s,u[r]=!0))},t.childNodes),a}}),rl.rpc.SDT_LOADING=rl.rpc.sdtRequestStates.LOADING,rl.rpc.SDT_COMPLETE=rl.rpc.sdtRequestStates.COMPLETE,rl.rpc.SDT_OK=rl.rpc.sdtStatuses.OK,rl.rpc.SDT_LOAD_SUCCESS=rl.rpc.sdtStatuses.LOAD_SUCCESS});