orderjs.define("gui.tree.Node",["gui.engine","css>rl:inputs","css>rl:tree"],function(){rl.gui.tree.Node=rl.createClass({parent:rl.gui.ContainerBase,construct:function(e){rl.isPrototyping(arguments[0])||(rl.gui.tree.Node.parent.call(this,e),this.dw=new rl.DomWrap,this.childNodes=[],this._selectedNodes=[],this._namedItemsStore={},this.id||(this.id=this.autoId()))},members:{ownerComp:null,owner:null,dataSource:null,id:"",domId:"",text:"",tip:"",icon:"",iconTip:"",leafIcon:"",branchIcon:"",openedBranchIcon:"",actionData:void 0,action:null,showChildrenNum:!1,depth:0,collapsed:!0,hidden:!1,_htmlTpl:new rl.HtmlTpl('<li class="node" id={id}><div class="content"><span class="elbow_indent">{indent}</span><img class="elbow_icon {elbowType}" src="{blankImg}" />{iconHtml}{selectorHtml}<a href="javascript:void(0)" title="{title}">{text}</a></div><ul class="chd_ctn {collapsedStateCss}">{chdHtml}</ul></li>'),_iconTpl:new rl.HtmlTpl('<img class="node_icon" src="{blankImg}" title="{iconTip}" style="{icon};" align="absmiddle" />'),_selectorTpl:new rl.HtmlTpl('<span class="rl_checkbox {checkedCss}"><img class="checkbox" src="'+rl.gui.URL_BLANK_IMG+'" align="absmiddle" border="0" /></span>'),loadItemNodes:function(e){var t=[],i=Function.bind(function(e){var i=this.loadItemNode(e);i&&t.push(i)},this);rl.isArray(e)?Array.each(i,e):i(e),this.addItems(t)},loadItemNode:function(e){if(!e)return null;var t,i,n,s=this.ownerComp||this.tree,o=s.xjsonItemName;return n=e["@attributes"]||e,n.domId=s.id+"_"+n.id,i=e[o],t=s.createNode(n),i&&t.loadItemNodes(i),rl.config.debugMode&&(s._totalNodesNum||(s._totalNodesNum=1),s._totalNodesNum+=1),t},getSelectedItems:function(){return this._selectedNodes},getRenderHtml:function(e){var t="",i="",n="",s=(this.dataSource,this.collapsed),o=this.ownerComp,r=e?"":this.getDescendantsHtml(!e),h=this.getElbowType();if(o.showIcons){this.initIcons();var l=this.icon;rl.isNonNullStr(l)&&(l="background-image:url("+l+")"),i=this._iconTpl.assign({blankImg:o.blankImg,iconTip:this.iconTip,icon:l})}return"multi"===o.selectorType&&(n=this._selectorTpl.assign({checkedCss:this.selected?" rl_checkbox_checked ":""})),t=this._htmlTpl.assign({id:this.domId,blankImg:o.blankImg,text:this.text,title:this.tip,collapsedStateCss:s?"collapsed":"",iconHtml:i,selectorHtml:n,elbowType:h,chdHtml:r,indent:this.getIndentHtml()})},initIcons:function(){var e,t,i,n=this.ownerComp,s=this.icon,o=n.iconRoot||"",r=rl.isNonNullStr;r(s)?(this.icon=o+s,e=t=i=this.icon):(e=n.defaultLeafIcon,t=n.defaultBranchIcon,i=n.defaultOpenedBranchIcon),this.leafIcon=r(this.leafIcon)?o+this.leafIcon:e,this.branchIcon=r(this.branchIcon)?o+this.branchIcon:t,this.openedBranchIcon=r(this.openedBranchIcon)?o+this.openedBranchIcon:i,r(this.icon)||(this.icon=this.hasChildren()?this.collapsed?this.branchIcon:this.openedBranchIcon:this.leafIcon)},getElbowType:function(){var e="elbow",t=(this.owner,""),i="";return this.hasChildren()&&this.hasShowingChildren()&&(i=this.collapsed?"_collapsed":"_expanded"),this.owner instanceof rl.gui.tree.RootNode&&this.isStartShowing()?t="_s":this.isEndShowing()&&(t="_e"),this.elbowType=e+i+t,this.elbowType},isStartShowing:function(){for(var e=this.previousSibling;e;){if(!e.hidden)return!1;e=e.previousSibling}return!0},isEndShowing:function(){for(var e=this.nextSibling;e;){if(!e.hidden)return!1;e=e.nextSibling}return!0},hasShowingChildren:function(){var e=Array.every(function(e){return e.hidden},this.childNodes);return!e},getIndentHtml:function(){var e,t=[],i=this.owner,n=this.ownerComp;if(i){if(i instanceof rl.gui.tree.RootNode)return"";t.push(i.getIndentHtml()),e=i.isEndShowing()?'<img class="elbow_icon" src="'+n.blankImg+'" />':'<img class="elbow_icon elbow_line" src="'+n.blankImg+'" />',t.push(e)}return t.join("")},getDescendantsHtml:function(e){var t=Array.map(function(t){return t.getRenderHtml(!e)},this.childNodes);return t.join("")},afterRender:function(){var e=this.ownerComp;this._bindDom(),e.lazyRender||(this.each(this._callChildAfterRender),this._childrenRendered=!0),this._rendered=!0,this.fireEvent("render")},_callChildAfterRender:function(e){e.afterRender()},_bindDom:function(){rl.isElement(this.dw.dom)||this.dw.setTarget(this.domId),this.childNodesCtn=this.dw.dom.lastChild},render:function(e){if(this._rendered)return this;var t,i=this.ownerComp.lazyRender,n=this.getRenderHtml(i);return t=rl.dom.insertHtml(this.renderPosition,n,e),this.dw.setTarget(t),this.afterRender(),this},renderChildren:function(){this.each(this._renderChd),this._childrenRendered=!0},_renderChd:function(e){e.render(this.childNodesCtn)},contains:function(e){return this.childNodes.contains(e)},within:function(e){return e&&e instanceof rl.gui.tree.Node?e==this?!0:this.within(e.owner):!1},hasChildren:function(){return this.childNodes.length>0},appendChild:function(e){if(!e)return!1;if(this.contains(e))return!0;if(e.owner&&rl.isFunction(e.owner.removeChild)&&e.owner.removeChild(e),this.hasChildren()){var t=this.lastChild;t.nextSibling=e,e.previousSibling=t,this.lastChild=e}else this.firstChild=this.lastChild=e;return e.owner=this,this.childNodes.push(e),e.selected&&this._selectedNodes.push(e),this._appendChildDom(e.dw.dom),this._hndChdChange(),this.fireEvent("add",e),e},insertBefore:function(e,t){if(!e instanceof rl.gui.tree.Node)return!1;if(!this.contains(t))return this.appendChild(e);var i=t.previousSibling;return this.contains(i)?e.previousSibling=i:this.firstChild=e,t.previousSibling=e,e.nextSibling=t,e.owner=this,node.owner=this,this.childNodes.push(node),node.selected&&this._selectedNodes.push(node),this._appendChildDom(node.dw.dom),this._hndChdChange(),this.fireEvent("add",node),e},removeChild:function(e){if(!this.contains(e))return!1;var t=e.previousSibling,i=e.nextSibling;t&&i?(t.nextSibling=i,i.previousSibling=t):t?(this.lastChild=t,delete t.nextSibling):i?(this.firstChild=i,delete i.previousSibling):this.firstChild=this.lastChild=null,e.owner=e.previousSibling=e.nextSibling=null,this.childNodes.remove(e),e.selected&&this._selectedNodes.remove(e),this._removeChilddDom(e.dw.dom),this._hndChdChange(),this.fireEvent("remove",e)},isBlankArea:function(e){var t=rl.$(e);return t.isTag("div")&&t.hasClass("content")?!0:t.hasClass("node_icon")||t.hasClass("rl_checkbox")||t.hasClass("checkbox")||t.isTag("a")||t.isTag("input")?!1:!0},doAction:function(e){var t=this.ownerComp,i=this._getIndentCtn();if(!rl.$(i).within(e)){if(rl.$(e).hasClass("elbow_icon")&&rl.$(e.parentNode).isTag("div"))return this.toggleCollapse();if(!t||t.trackBlank||!this.isBlankArea(e)){var n=t?t.selectorType:"";switch(n){case"single":this.hasChildren()?(this.toggleCollapse(),(!t||t.branchesSelectable)&&(this.focus(),t.setSingleSelected(this))):(this.focus(),t&&t.setSingleSelected(this));break;case"multi":this.focus(),this.selected?(this.unSelect(),this.unSelectAll()):(this.select(),this.selectAll()),t&&t.hndNodesSelectChange();break;default:this.open()}}}},open:function(){var data=this.actionData,ownerComp=this.ownerComp;return this.focus(),rl.isNonNullStr(data)&&ownerComp&&ownerComp.URIActionData&&(data=encodeURI(data)),rl.isNonNullStr(this.action)?eval(this.action):rl.isFunction(this.action)?this.action(data,this):rl.isDefined(data)&&ownerComp&&rl.isFunction(ownerComp.action)&&ownerComp.action(data,this),this},focus:function(){return this.focused?this:(this.focused=!0,this._addFocusedStyle(),this.ownerComp&&this.ownerComp.afterChildFocus(this),this)},blur:function(){return this.focused?(this.focused=!1,this._removeFocusedStyle(),this):this},filterChildrenViewBy:function(e,t,i){for(var n,s,o=(i||this).childNodes,r=o.length,h=this.ownerComp||this.tree,l=0;r>l;l++)n=o[l],n.hasChildren()&&this.filterChildrenViewBy(e,t,n)||e.call(t,n)?(n.show(),h.firstFoundChild||(h.firstFoundChild=n),s=!0):n.hide();return s},show:function(){return this._rendered&&this.hidden?(this.dw.show(),this.hidden=!1,this.afterViewChange(),this):this},hide:function(){return!this._rendered||this.hidden?this:(this.dw.hide(),this.hidden=!0,this.afterViewChange(),this)},afterViewChange:function(){var e=this.owner;e&&rl.isFunction(e._delayUpdateView)&&Function.defer(e._delayUpdateView,e)},collapse:function(){if(this.collapsed||!this.hasChildren())return this;var e=this.dw.dom;return rl.isElement(e)&&rl.$(e.lastChild).addClass("collapsed"),this.collapsed=!0,this._updateElbowType(),this.setIcon(this.branchIcon),this},expand:function(){if(!this.collapsed||!this.hasChildren())return this;this._childrenRendered||this.renderChildren();var e=this.dw.dom;return rl.isElement(e)&&rl.$(e.lastChild).removeClass("collapsed"),this.collapsed=!1,this._updateElbowType(),this.setIcon(this.openedBranchIcon),this},toggleCollapse:function(){this.collapsed?this.expand():this.collapse()},setCollapse:function(e){e?this.collapse():this.expand()},getItems:function(){return this.childNodes},selectAll:function(){return this.startBatchSelect(),this.each(function(e){e.select(),e.selectAll()}),this.endBatchSelect(),this},unSelectAll:function(){return this.startBatchSelect(),this.each(function(e){e.unSelect(),e.unSelectAll()}),this.endBatchSelect(),this},startBatchSelect:function(){return this.batchSelecting=!0,this},endBatchSelect:function(){this.batchSelecting=!1;var e=this.ownerComp;return e&&rl.isFunction(e.afterNodeEndBatchSelect)&&e.afterNodeEndBatchSelect(this),this},afterSelectChange:function(){this.updateSelectStateView()},updateSelectStateView:function(){var e=this.ownerComp;if(e&&"multi"===e.selectorType){this._updateSelectorView();var t=this.owner;t&&rl.isFunction(t.updateSelectStateView)&&t.updateSelectStateView()}},_updateSelectorView:function(){if(this._rendered){var e=2,t=this.ownerComp;t&&t.showIcons&&(e=3);var i=this.dw.dom.firstChild.childNodes[e];if(i){var n=this.isDescendantChecked();this.selected?rl.$(i).removeClass("rl_checkbox_descendant_checked").addClass("rl_checkbox_checked"):n?rl.$(i).removeClass("rl_checkbox_checked").addClass("rl_checkbox_descendant_checked"):rl.$(i).removeClass("rl_checkbox_checked").removeClass("rl_checkbox_descendant_checked")}}},isDescendantChecked:function(){return this.hasChildren()?!!this.find(function(e){return e.selected||e.isDescendantChecked()?!0:!1},this):!1},afterAllSelectStateChange:function(e){e?this.select():this.unSelect()},_hndChdChange:function(){this._updateChdNum(),this._updateCollapseType(),this.checkAllSelectedState();var e=this.ownerComp;e&&rl.isFunction(e.afterTreeStructChange)&&e.afterTreeStructChange(this)},_updateCollapseType:function(){},_updateChdNum:function(){},_updateIndent:function(){if(this._rendered){var e=this._getIndentCtn();e&&(e.innerHTML=this.getIndentHtml())}},_getIndentCtn:function(){var e=this._indentCtn;if(!e){if(!this._rendered)return null;e=this._indentCtn=this.dw.dom.firstChild.firstChild}return e},_updateElbowType:function(){if(this._rendered){var e=this.dw.dom.firstChild.childNodes[1];rl.dom.swapClass(e,this.elbowType,this.getElbowType())}},setIcon:function(e){return!rl.isNonNullStr(e)||this.ownerComp&&!this.ownerComp.showIcons||this.icon==e?this:(this.icon=e,this._updateIconView(e),this)},getIcon:function(){return this.icon},_updateIconView:function(e){if(this._rendered&&rl.isNonNullStr(e)){var t=this.dw.dom.firstChild.childNodes[2],i="url("+e+")";rl.$(t).setStyle({backgroundImage:i})}},_addFocusedStyle:function(){if(this._rendered){var e=this.dw.dom.firstChild;rl.$(e).addClass("focused")}},_removeFocusedStyle:function(){var e=this.dw.dom.firstChild;rl.$(e).removeClass("focused")},_sortChildNodes:function(){if(this.hasChildren()){this.each(function(e){e._sortChildNodes()}),this.childNodes.sort(function(e,t){var i=e.hasChildren(),n=t.hasChildren();return i&&n?0:i?-1:t.hasChildren()?1:0});var e=null;this.each(function(t){t.nextSibling=null,t.previousSibling=null,e?(e.nextSibling=t,t.previousSibling=e,e=t):this.firstChild=this.lastChild=e=t,this._appendChildDom(t.dw.dom)}),this.lastChild=e,this._updateView()}},_updateView:function(){this.each(function(e){e.hasChildren()&&e._delayUpdateView(),e._updateIndent(),e._updateElbowType()})},_delayUpdateView:function(){clearTimeout(this._delayUpdateVeiwTimer),this._delayUpdateVeiwTimer=Function.delay(this._updateView,300,this)},_appendChildDom:function(e){rl.isElement(this.childNodesCtn)&&rl.isElement(e)&&this.childNodesCtn.appendChild(e)},_removeChilddDom:function(e){rl.isElement(e)&&e.parentNode&&e.parentNode.removeChild(e)},toString:function(){return"[object rl.gui.tree.Node]"}}}),rl.gui.tree.Node.prototype.add=rl.gui.tree.Node.prototype.appendChild,rl.gui.tree.Node.prototype.remove=rl.gui.tree.Node.prototype.removeChild,rl.fill(rl.gui.tree.Node.prototype,rl.gui.itf.iSelectable),rl.fill(rl.gui.tree.Node.prototype,rl.gui.itf.iItemsSelectable)});