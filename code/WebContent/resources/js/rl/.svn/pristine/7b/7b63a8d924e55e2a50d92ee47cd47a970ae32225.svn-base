orderjs.define("gui.form.FormHelper",["css>rl:default","lib.dom.engine","lib.rpc.engine","lib.rpc.SdtHelper","gui.engine","gui.form.engine","gui.form.Validator"],function(){rl.gui.form.FormHelper=rl.createClass({parent:rl.util.EventProvider,construct:function(t){rl.isPrototyping(arguments[0])||(rl.gui.form.FormHelper.parent.call(this,t),rl.ext(this,t),this.initialize(t))},members:{form:null,rules:null,action:void 0,actionHandler:void 0,actions:null,expectRspType:"xml",autoObserveOnReady:!0,validator:null,itemValidationCss:"",errMsgCss:"rl_error_msg",initialize:function(){this._itemsErrMsgTypeStore={},this._itemsErrMsgCtnStore={},this.initValidator(),this.autoObserveOnReady&&rl.onReady(Function.bind(this.observe,this))},observe:function(){var t=this.getForm(),i=this.validator;t&&i&&rl.$(t).on(t.addEventListener?"blur":"focusout",this.validateTargetBy,this,!0)},validate:function(){return this.validator.validate(this.getForm())},validateTargetBy:function(t){return this.validateElement(rl.ew.init(t).getTarget())},validateElement:function(t){if(!rl.isElement(t))return this;var i=this.getForm(),r=this.validator;if(i&&r&&r.rules){var e=t.name,s=r.rules[e];e&&s&&t.form==i&&(t=i[e],Function.delay(function(){var i=rl.gui.form.Validator,r=i.validateFormItem(t,s);r===!0?this.hndItemValidateSuccess(t,s,e,r):this.hndItemValidateFailure(t,s,e,r)},200,this))}},addRule:function(){var t=this.validator;return t.addRule.apply(t,arguments)},doAction:function(t){if(this.isRequesting())return!1;var i,r=this.actions;return rl.isNonNullStr(t)&&r&&(i=this.actions[t],this.activeActionName=t),i||(i=this.action||this.getForm().action,this.activeActionName=void 0),this._doAction(i)},getForm:function(){var t=this.form;return rl.isElement(t)||(t=this.form=rl.gui.form.getForm(this.form)),t},setFormAction:function(t){this._formAction=t},getFormAction:function(){var t=this._formAction;if(!rl.isString(t)){var i=this.action;t=i,!rl.isString(t)&&rl.isObject(i)&&(t=i.action),rl.isString(t)||(t=this.getForm().action)}return t},isRequesting:function(){var t=this._reqHelper;return t&&t.isRequesting()},isSameItemErrMsg:function(t,i){var r=this._itemsErrMsgTypeStore[t];return r===i},getItemErrMsgCtn:function(t,i,r){var e=this._itemsErrMsgCtnStore[r];return e||(e=this.createItemErrMsgCtn(t,i,r),this._itemsErrMsgCtnStore[r]=e),e},createItemErrMsgCtn:function(t,i){var r=document.createElement("span");rl.isNonNullStr(this.errMsgCss)&&(r.className=this.errMsgCss);var e=rl.getDom(i.msgCtn);return rl.isElement(e)?e.appendChild(r):(t.length&&(t=t[0]),rl.dom.insertElements("afterend",r,t)),r},showMask:function(){this.mask||(this.mask=rl.gui.maskLayerPool.pull());var t=rl.dom.viewport;this.mask.setStyle({left:"0px",top:"0px",zIndex:1,width:t.getDocumentWidth()+"px",height:t.getDocumentHeight()+"px"})},hideMask:function(){rl.gui.maskLayerPool.push(this.mask),this.mask.hide(),this.mask=null},showErrMsg:function(t){var i=this._itemsErrMsgCtnStore[t];i&&(i.style.display="")},hideErrMsg:function(t){var i=this._itemsErrMsgCtnStore[t];i&&(i.style.display="none")},hasErrMsgShown:function(t){var i=this._itemsErrMsgCtnStore[t];return i?rl.$(i).displayed():void 0},hndItemValidateFailure:function(t,i,r,e){if(!this.isSameItemErrMsg(r,e)){var s=this.getItemErrMsgCtn(t,i,r),n=i.msg||rl.gui.form.Validator.getErrMsg(e,i);s.innerHTML=n,this._itemsErrMsgTypeStore[r]=e}this.hasErrMsgShown(r)||this.showErrMsg(r),rl.$(t).addClass(this.itemValidationCss)},hndItemValidateSuccess:function(t,i,r){this.hasErrMsgShown(r)&&(this.hideErrMsg(r),rl.$(t).removeClass(this.itemValidationCss))},_getActionHandler:function(t){var i,r,e=this.actions;return rl.isNonNullStr(t)&&e&&(r=e[t]),rl.isObject(r)&&rl.isFunction(r.handler)&&(i=r.handler),!rl.isFunction(i)&&rl.isObject(this.action)&&(i=this.action.handler),rl.isFunction(i)||(i=this.actionHandler),i},_requestHandler:function(){var t=this._getActionHandler(this.activeActionName);rl.isFunction(t)&&t.apply(this,arguments)},initReqHelper:function(){var t=!1,i=this.getForm();i&&(t="multipart/form-data"==i.getAttribute("enctype")),this._reqHelper=new rl.rpc.SdtHelper({multipart:t,expectRspType:this.expectRspType,onComplete:Function.bind(this._requestHandler,this)});var r=this._reqHelper.httpRequest;r.on("success",this.hideMask,this),r.on("failure",this.hideMask,this),r.on("abort",this.hideMask,this),r.on("loading",this.showMask,this)},initValidator:function(){if(!this.validator){var t=this.validator=this.createValidator();t.on("ipass",this.hndItemValidateSuccess,this),t.on("ifail",this.hndItemValidateFailure,this)}},createValidator:function(){return new rl.gui.form.Validator({rules:this.rules})},_submitForm:function(){if(this._reqHelper){if(this.isRequesting())return}else this.initReqHelper();this.validate()&&this._reqHelper.request({sendData:this.getForm(),url:this.getFormAction()})},_doAction:function(t,i){if(rl.isNonNullStr(t))return this.setFormAction(t),this._submitForm(),!0;if(rl.isFunction(t)){var r=t.call(this);return r!==!1&&this._submitForm(),!0}return rl.isObject(t)&&!i?this._doAction(t.action,!0):!1},toString:function(){return"[object rl.gui.form.FormHelper]"}}}),rl.gui.ctype2Classes.add("FormHelper",rl.gui.form.FormHelper)});