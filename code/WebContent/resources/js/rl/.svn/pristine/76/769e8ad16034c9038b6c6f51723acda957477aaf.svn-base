/*! JsObservable v1.0.0-alpha: http://github.com/BorisMoore/jsviews and http://jsviews.com/jsviews
informal pre V1.0 commit counter: 53 (Beta Candidate) */
/*
 * Subcomponent of JsViews
 * Data change events for data-linking
 *
 * Copyright 2014, Boris Moore
 * Released under the MIT License.
 */
!function(t,e,r){"use strict";function n(t){return I(t)?new s(t):new a(t)}function a(t){return this._data=t,this}function s(t){return this._data=t,this}function i(t){return I(t)?[t]:t}function o(t,e){t=I(t)?t:[t];var r,n,a=e,s=a,i=t.length,l=[];for(r=0;i>r;r++)n=t[r],V(n)?l=l.concat(o(n.call(e,e),e)):""+n===n?(s!==a&&l.push(a=s),l.push(n)):(e=s=n,s!==a&&l.push(a=s));return l}function l(t,e){var r,n;for(r in t){n=!0;break}n||delete P[e]}function c(t,e){if(!t.data||!t.data.off){var n,a,s,i=e.oldValue,o=e.value,l=t.data,c=l.observeAll,f=!l.cb.noArray,h=l.paths;t.type===C?(l.cb.array||l.cb).call(l,t,e):(l.prop===e.path||"*"===l.prop)&&(i=typeof i===j&&(h[0]||f&&I(i))&&i,o=typeof(o=e.value)===j&&(h[0]||f&&I(o))&&o,c?(n=c._path+"."+e.path,a=c.filter,s=[c.parents().slice()],i&&u(f,c.ns,[i],h,l.cb,!0,a,s,n),o&&u(f,c.ns,[o],h,l.cb,r,a,s,n)):(i&&u(f,[i],h,l.cb,!0),o&&u(f,[o],h,l.cb)),l.cb(t,e))}}function f(){function t(t,r,n,a){var s,o,l=T(te),f=i(te);if(t=K?t+"."+K:t,_||a)l&&e(f).off(t,c);else{if(Q=l&&e._data(te))for(Q=Q&&Q.events,Q=Q&&Q[n?C:k],w=Q&&Q.length;w--;)if((B=Q[w].data)&&B.cb._cId===y._cId&&B.ns===K){if(n)return;("*"===r&&B.prop!==r||B.prop===b)&&e(te).off(t,c)}o=n?{}:{fullPath:v,paths:r?[r]:[],prop:b},o.ns=K,o.cb=y,G&&(o.observeAll={_path:G,path:function(){return s=E.length,G.replace(/[[.]/g,function(t){return s--,"["===t?"["+e.inArray(E[s-1],E[s]):"."})},parents:function(){return E},filter:J,ns:K}),e(f).on(t,null,o,c),F&&(F[e.data(te,"obId")||e.data(te,"obId",D++)]=te)}}function a(t,e){t._ob=S(t,Z);var r=Z;return function(n,a){var i=t._ob,o=e.length;typeof i===j&&(s(i,!0),(o||R&&I(i))&&u(R,[i],e,y,S,!0)),i=t._ob=S(t,r),typeof i===j&&(s(i),(o||R&&I(i))&&u(R,[i],e,y,S,[r])),y(n,a)}}function s(e,a,s,i){if(R){var o=te,l=G;te=e,i&&(te=e[i],G+="."+i,J&&(te=n._fltr(i,e,G,J))),te&&(s||I(te))&&t(C+".observe"+(y?".obs"+(A=y._cId=y._cId||H++):""),r,!0,a),te=o,G=l}}var f,h,p,g,b,v,d,_,y,A,w,B,Q,S,q,F,M,z,E,G,J,K,L,N,R=0!=this,U=1,W=O,X=Array.apply(0,arguments),Y=X.pop(),Z=X.shift(),$=Z,te=$,ee=X.length;for(Z+""===Z&&R&&(K=Z,Z=te=$=X.shift(),ee--),V(Y)?y=Y:(Y+""===Y&&(G=Y,E=X.pop(),J=X.pop(),Y=X.pop(),ee-=3),Y===!0?_=Y:Y&&(Z=Y,U=0),Y=X[ee-1],(ee&&Y===r||V(Y))&&(y=X.pop(),ee--)),ee&&V(X[ee-1])&&(S=y,y=X.pop(),ee--),W+=_?y?".obs"+y._cId:"":".obs"+(A=y._cId=y._cId||H++),_||(F=P[A]=P[A]||{}),L=K&&K.match(x)||[""],N=L.length;N--;)for(K=L[N],I($)?s($,_,!0):_&&0===ee&&$&&t(W,""),M=0,f=0;ee>f;f++)if(v=X[f],""!==v){if(te=$,""+v===v){if(g=v.split("^"),g[1]&&(M=g[0].split(".").length,v=g.join("."),M=v.split(".").length-M),S&&(q=S(v,$))){ee+=q.length-1,m.apply(X,[f--,1].concat(q));continue}g=v.split(".")}else U&&!V(v)&&(v._jsvOb&&(v._cb=z=a(v,X.slice(f+1)),z.noArray=R===!1,z._cId=y._cId,u(R,[Z],X.slice(0,f),v._cb,S),v=v._ob),te=v),$=v,g=[$];for(;te&&(b=g.shift())!==r;)if(typeof te===j){if(""+b===b){if(""===b)continue;if(g.length<M+1&&!te.nodeType){if(!_&&(Q=T(te)&&e._data(te))){for(Q=Q.events,Q=Q&&Q[k],w=Q&&Q.length,p=0;w--;)B=Q[w].data,B&&B.cb===y&&B.ns===K&&(B.prop===b||"*"===B.prop)&&((h=g.join("."))&&B.paths.push(h),p++);if(p){te=te[b];continue}}if("*"===b){!_&&Q&&Q.length&&t(W,"",!1,!0),V(te)?(d=te.depends)&&u(R,[d],y,_||Z):t(W,"");for(h in te)s(te,_,r,h);break}b&&t(W+"."+b,g.join("."))}G&&(G+="."+b),b=te[b]}if(V(b)){(d=b.depends)&&u(R,[te],o(d,te),y,S,_||[Z]);break}te=b}s(te,_)}return A&&l(F,A),{cbId:A,bnd:F,leaf:te}}function h(){return[].push.call(arguments,!0),f.apply(this,arguments)}function u(){var t=[].concat.apply([],arguments);return f.apply(t.shift(),t)}function p(t,e,r){return r.indexOf(".")<0&&r.indexOf("[")<0&&e[t]}function g(t,n,a,s,i){return s=s||p,i=i||p,{getTgt:t,obsSrc:n,obsTgt:a,map:function(r){var o=this;if(o.src!==r&&(o.src&&o.unmap(),typeof r===j)){var l,c=t.apply(o,arguments);e.observable&&(e.observable(r).observeAll(o.obs=function(t,e){!l&&n&&(l=!0,n.call(o,r,c,t,e),l=!1)},s),e.observable(c).observeAll(o.obt=function(t,e){!l&&a&&(l=!0,a.call(o,r,c,t,e),l=!1)},i)),o.src=r,o.tgt=c}return o},unmap:function(){if(e.observable){var t=this;t.src&&(e.observable(t.src).unobserveAll(t.obs,s),e.observable(t.tgt).unobserveAll(t.obt,i),t.src=t.tgt=r)}}}}function b(t,e,r,n){t+""!==t&&(r=e,e=t,t=""),d(t,this._data,e,r,[],"root",n)}function v(t,e,r){b.call(this,t,e,r,!0)}function d(t,e,a,s,i,o,l){function c(e,r){for(u=e.length,g=o+"[]";u--;)(b=n._fltr(u,e,g,s))&&d(t,b,a,s||"",i.slice(),g,r)}function h(e,r){o=e.data.observeAll._path;var n=i;switch(i[0]!==e.target&&(i=i.slice(),i.unshift(e.target)),r.change){case"insert":c(r.items);break;case"remove":c(r.items,!0);break;case"refresh":c(r.oldItems,!0),c(e.target);break;case"set":g=o+"."+r.path,d(t,r.oldValue,a,0,i.slice(),g,!0),d(t,r.value,a,0,i.slice(),g)}a.apply(this,arguments),i=n}var u,p,g,b;if(typeof e===j)if(p=I(e)?"":"*",i.unshift(e),a?(p||0!==s)&&(h._cId=a._cId=a._cId||H++,f(t,e,p,h,l,s,i.slice(),o)):f(t,e,p,r,l,s,i.slice(),o),p)for(u in e)"_"!==u.charAt(0)&&u!==A&&(g=o+"."+u,(b=n._fltr(u,e,g,s))&&d(t,b,a,s||0,i.slice(),g,l));else c(e,l)}if(!e)throw"jsViews/jsObservable require jQuery";if(!e.observable){var _=e.event.special,y=e.views?e.views.sub:n.sub={},m=[].splice,I=e.isArray,A=e.expando,j="object",w=parseInt,x=/\S+/g,k=y.propChng=y.propChng||"propertyChange",C=y.arrChng=y.arrChng||"arrayChange",P=y._cbBnds=y._cbBnds||{},O=k+".observe",V=y.isFn,D=1,H=1,T=e.hasData;y.getDeps=function(){var t=arguments;return function(){for(var e,r,n=[],a=t.length;a--;)e=t[a--],r=t[a],r&&(n=n.concat(V(r)?r(e,e):r));return n}},y.DataMap=g,e.observable=n,n._fltr=function(t,e,r,n){var a=n&&V(n)?n(t,e,r):e[t];return a&&(a=V(a)?a.set&&a.call(e):a),typeof a===j&&a},n.Object=a,n.Array=s,e.observe=n.observe=f,e.unobserve=n.unobserve=h,n._apply=u,a.prototype={_data:null,observeAll:b,unobserveAll:v,data:function(){return this._data},setProperty:function(t,e,n){var a,s,i,o=this,l=o._data;if(t=t||"",l)if(I(t))for(a=t.length;a--;)s=t[a],o.setProperty(s.name,s.value,n===r||n);else if(""+t!==t)for(a in t)o.setProperty(a,t[a],e);else if(t!==A){for(i=t.split(".");l&&i.length>1;)l=l[i.shift()];o._setProperty(l,i.join("."),e,n)}return o},_setProperty:function(t,e,r,n){var a,s,i=e?t[e]:t;V(i)&&i.set&&(s=i,a=i.set===!0?i:i.set,i=i.call(t)),(i!==r||n&&i!=r)&&(!(i instanceof Date)||i>r||r>i)&&(a?(a.call(t,r),r=s.call(t)):e&&(t[e]=r),this._trigger(t,{change:"set",path:e,value:r,oldValue:i}))},_trigger:function(t,r){e(t).triggerHandler(k,r)}},s.prototype={_data:null,observeAll:b,unobserveAll:v,data:function(){return this._data},insert:function(t,e){var r=this._data;return 1===arguments.length&&(e=t,t=r.length),t=w(t),t>-1&&t<=r.length&&(e=I(e)?e:[e],e.length&&this._insert(t,e)),this},_insert:function(t,e){var r=this._data,n=r.length;m.apply(r,[t,0].concat(e)),this._trigger({change:"insert",index:t,items:e},n)},remove:function(t,e){var n,a=this._data;return t===r&&(t=a.length-1),t=w(t),e=e?w(e):0===e?0:1,e>-1&&t>-1&&(n=a.slice(t,t+e),e=n.length,e&&this._remove(t,e,n)),this},_remove:function(t,e,r){var n=this._data,a=n.length;n.splice(t,e),this._trigger({change:"remove",index:t,items:r},a)},move:function(t,e,r){if(r=r?w(r):0===r?0:1,t=w(t),e=w(e),r>0&&t>-1&&e>-1&&t!==e){var n=this._data.slice(t,t+r);r=n.length,r&&this._move(t,e,r,n)}return this},_move:function(t,e,r,n){var a=this._data,s=a.length;a.splice(t,r),a.splice.apply(a,[e,0].concat(n)),this._trigger({change:"move",oldIndex:t,index:e,items:n},s)},refresh:function(t){var e=this._data.slice();return this._refresh(e,t),this},_refresh:function(t,e){var r=this._data,n=r.length;m.apply(r,[0,r.length].concat(e)),this._trigger({change:"refresh",oldItems:t},n)},_trigger:function(t,r){var n=this._data,a=n.length,s=e([n]);s.triggerHandler(C,t),a!==r&&s.triggerHandler(k,{change:"set",path:"length",value:a,oldValue:r})}},_[k]=_[C]={remove:function(t){var r,n,a,s,i,o=t.data;if(o&&(o.off=1,o=o.cb)&&(r=P[o._cId])){for(a=e._data(this).events[t.type],s=a.length;s--&&!n;)n=(i=a[s].data)&&i.cb===o;n||(delete r[e.data(this,"obId")],l(r,o._cId))}}}}}(this,this.jQuery);