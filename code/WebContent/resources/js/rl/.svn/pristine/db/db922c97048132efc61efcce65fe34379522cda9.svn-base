/**
 * @fileOverview Grid module.
 * @change
 	#1 by prcjack Creates file.
	#2 by prcjack @2014/02/21 Add rendered check b4 setWidth or setHeight.
	#3 by prcjack @2014/02/27 Fix chrome alert bug on unload.
	#4 by prcjack @2014/02/27 Fix data load alert bug on unload.
	#5 by prcjack @2014/04/01 Fix auto fit width.
	#6 by prcjack @2014/05/29 Merged "gui.grid.Row", "gui.grid.Head", "gui.grid.Body",
		"gui.grid.Column", "gui.grid.RowNumberer", "gui.grid.RowSelector",
		"gui.grid.PagingBar".
	#7 by prcjack @2014/05/30 Add minWidth, maxWidth support for column.
	#8 by prcjack @2014/07/11 Fix showPagingLimit bug.
	#9 by prcjack @2014/10/20 Fix hideCell bug.
 */
orderjs.define("gui.grid.Grid",["lib.data.Table","lib.dnd.engine","gui.engine","gui.form.Input","gui.form.Label","gui.form.Combox","gui.menu.ToolBar","css>rl:grid"],function(){!function(){rl.gui.grid.Row=rl.createClass({parent:rl.gui.ComponentBase,construct:function(t){rl.isPrototyping(arguments[0])||(rl.gui.grid.Row.parent.call(this,t),this.dw=new rl.DomWrap,this.cellComps=[])},members:{ownerComp:null,dataSource:null,rowIndex:0,_interactiveMouseTypes:["out","over"],_reColIndexCss:/col_\d.*$/,_cellHtmlTpl:new rl.HtmlTpl('<td style="{display}"><div class="cell {css}" style="width:{width};"><span>{text}</span></div></td>'),getRenderHtml:function(){var t,e,i,r,s,n,o=["<tr id='"+this.id+"' "],l=this.dataSource,a=this.rowIndex,d=this.owner,h=d.cols,c=d.stripeRows,u=this._cellHtmlTpl,g=rl.dom.addUnit,f="display:none";c&&a%2!=0&&o.push("class='strip_row' "),o.push(" >");for(var m=0,p=h.length;p>m;m++)r=h[m],t=r.cellCss+" col_"+m,r.cellCompType&&r.cellCompType.prototype instanceof rl.gui.ComponentBase?e="":(e=l.getValue(r.name),n=r.convert,n&&(e=n.call(r,e,m,a,l)),rl.isEmpty(e)&&(e=d.emptyText||"")),s=r.visible?"":f,i=g(r.width),o.push(u.assign({css:t,text:e,display:s,width:i}));return o.push("</tr>"),o.join("")},render:function(t){if(this._rendered)return this;t=this.getRenderTarget(t);var e=rl.dom.insertHtml(this.renderPosition,this.getRenderHtml(),t);return this.dw.setTarget(e),this._rendered=!0,this.fireEvent("render"),this},afterRenderByOwner:function(){this.dw.setTarget(this.id),this._rendered=!0},createColComponent:function(t){var e,i=this.dataSource,r=this.rowIndex,s=t.displayIndex,n=i.getValue(t.name);return opt=(t.getCellCompConfig||rl.EMPTY_FUNCTION)(n,s,r,i),opt.renderTarget=this.getCellCompCtn(s),e=new t.cellCompType(opt),e.render(),this.cellComps.push(e),e},getCellCompCtn:function(t){return this.getCellEle(t).firstChild.firstChild},focus:function(){this.dw.focus(),this.dw.addClass("rl_row_focused")},blur:function(){this.dw.blur(),this.dw.removeClass("rl_row_focused")},hide:function(){this.dw.setStyle({display:"none"})},show:function(){this.dw.setStyle({display:""})},hideCell:function(t){var e=this.getCellEle(t);rl.isElement(e)&&(e.style.display="none")},showCell:function(t){var e=this.getCellEle(t);rl.isElement(e)&&(e.style.display="")},setWidth:function(){return this},setCellWidth:function(t,e){var i=this.getCols();if(!i)return this;var r=this.getCellEle(t),s=i[t];e>s.maxWidth?e=s.maxWidth:e>s.minWidth||(e=s.minWidth),rl.isElement(r)&&(rl.isFunction(s.setCellWidth)?s.setCellWidth(r,e):rl.$(r.firstChild).setWidth(e))},getCellContentWidth:function(t){var e=this.getCols();if(!e)return this;var i=this.getCellEle(t),r=e[t];return r&&r.getCellContentWidth?r.getCellContentWidth(i):i.firstChild.firstChild.offsetWidth},getCellEle:function(t){var e=this.dw.getDom();if(rl.isElement(e)){var i=e.cells;if(i)return i[t]}},getCellSelectorEle:function(t){return rl.isElement(t)||(t=this.getCellEle(t)),rl.isElement(t)?t.getElementsByTagName("input")[0]:void 0},getCellEleByChild:function(t){return rl.dom.findParentBy(t,this._isCellEle,this)},getCellEleByEvent:function(t){var e=rl.ew.init(t).getTarget();return this.getCellEleByChild(e)},getIndexFromCellEle:function(t){var e=-1;if(rl.isElement(t)){var i=t.firstChild;if(!rl.isElement(t))return e;var r=i.className,s=this._reColIndexCss,n=r.match(s)[0];rl.isNonNullStr(n)&&(e=parseInt(n.match(/\d.*$/)[0]))}return e},_isCellEle:function(t){var e=this.dw.dom;return e&&t.parentNode==e},afterSelectChange:function(){this.updateSelectStateView()},updateSelectStateView:function(t){var e=rl.gui.grid.RowSelector;e&&(t=void 0===t?this.selected:t,Array.each(function(i,r){if(i instanceof e&&i.bindRowSelectAction){var s=this.getCellSelectorEle(r);s&&(s.checked=t)}},this.getCols(),this))},getCols:function(){return this.owner?this.owner.cols:void 0},reRenderColNum:function(){var t,e,i=this.owner.cols[0];i instanceof rl.gui.grid.RowNumberer&&(e=this.getCellEle(0),rl.isElement(e)&&(t=i.convert(null,null,this.rowIndex),e.firstChild.innerHTML=t))},reStripRow:function(t){t?this.dw.addClass("strip_row"):this.dw.removeClass("strip_row")},setRowIndex:function(t){if(rl.isNumber(t)||(t=parseInt(t)),isNaN(t))throw{description:this+"Invalid rowIndex = "+t};this.rowIndex!==t&&(this.rowIndex=t,this.hndRowIndexChange(),this.fireEvent("rowIndexChange",t))},hndRowIndexChange:function(){var t=this.owner,e=t.cols[0];e instanceof rl.gui.grid.RowNumberer&&this.reRenderColNum(),t.stripeRows&&this.reStripRow(this.rowIndex%2!=0)},setValue:function(t,e){var i=this.owner.grid.toIndex(t);i>-1&&this.setCellContent(i,e)},setValues:function(t){for(var e in t)this.setValue(e,t[e]);return this},setCellContent:function(t,e){var i=this.getCellEle(t);if(i){var r=i.firstChild;r.innerHTML=e}},onDispose:function(){Array.each(function(t){t&&t.dispose&&t.dispose()},this.cellComps),this.cellComps=[],this.dw.dispose(),delete this.dw,delete this.owner},_getInteractiveStateCss:function(t){var e="rl_row_";return this.selected?e+="selected":"out"==t?e="":e+=t,e},toString:function(){return"[object rl.gui.grid.Row]"}}}),rl.fill(rl.gui.grid.Row.prototype,rl.gui.itf.iInteractive),rl.fill(rl.gui.grid.Row.prototype,rl.gui.itf.iSelectable)}(),function(){rl.gui.grid.Head=rl.createClass({parent:rl.gui.grid.Row,construct:function(t){rl.isPrototyping(arguments[0])||(rl.gui.grid.Head.parent.call(this,t),this.dw=new rl.DomWrap)},members:{_cellHtmlTpl:new rl.HtmlTpl('<td id="{id}" style="{display}"><div class="cell {css}" style="width:{width};"><span>{text}</span><span class="sort_arrow">&nbsp;&nbsp;</span><span class="resizer {resizableCss}" title="{resizerTip}">&nbsp;</span></div></td>'),_htmlTpl:new rl.HtmlTpl('<table class="row" id="{id}" border="0" cellspacing="0" cellpadding="0"><tr>{cellsHtml}</tr></table>'),render:function(t){if(this._rendered)return this;var e,i=this.id,r=this.getRenderHtml();return t.innerHTML=this._htmlTpl.assign({id:i,cellsHtml:r}),e=t.firstChild,this.dw.setTarget(e),rl.gui.makeUnselectable(e,!0),this.afterRender(),this._rendered=!0,this.fireEvent("render"),this},getRenderHtml:function(){for(var t,e,i,r,s,n=[],o=this.cols,l=this.id+"_",a=this._cellHtmlTpl,d=rl.dom.addUnit,h="",c="resizableCss",u=this.grid.resizeIndicatorTip,g="display:none",f=0,m=o.length;m>f;f++)i=o[f],r=i.headCss,e=l+f,t=i.caption||"&nbsp;",s=i.visible?"":g,i.convertCaption&&(t=i.convertCaption(t)),c="",h="",i.resizable&&(c="resizable",h=u),n.push(a.assign({text:t,css:r,id:e,display:s,resizableCss:c,resizerTip:h,width:d(i.width)}));return n.join("")},afterRender:function(){var t=this.dw,e=t.getDom(),i=rl.util.CustomUIEventsMgr;t.on("mouseover",this.hndMouseover,this),t.on("mouseout",this.hndMouseout,this),t.on("click",this.hndClick,this),t.on("dblclick",this.hndDblclick,this),i.addEventListener(e,"beforedrag",this.hndDndResizeB4Start,this),i.addEventListener(e,"draging",this.hndDndResizing,this),i.addEventListener(e,"dragend",this.hndDndResized,this)},getCellContentWidth:function(t){var e=this.grid.getCol(t);return e?rl.isNonNullStr(e.caption)?6*e.caption.bLen()+10:rl.isNumber(e.width)?e.width:0:0},getCellEle:function(t){var e=this.dw.getDom();if(rl.isElement(e)&&e.rows){var i=e.rows[0].cells;if(i)return i[t]}},getIndexFromCellEle:function(t){if(rl.isElement(t)&&t.id){var e=t.id,i=parseInt(e.substr(e.lastIndexOf("_")+1));return isNaN(i)?-1:i}},setCellContent:function(t,e){var i=this.getCellEle(t);if(i){var r=i.firstChild.firstChild;r.innerHTML=e}},setCaption:function(t,e){this.setCellContent(t,e)},afterSort:function(t,e){var i=this.grid,r=i.toIndex(t),s=this.getCellEle(r);if(s){rl.isNonNullStr(this._lastSortingId)&&rl.$(this._lastSortingId).removeClass("sorting").removeClass("asc").removeClass("dec"),this._lastSortingId=s.id;var n=(e?"asc":"dec")+" sorting";rl.$(s).addClass(n)}},hideSortIndicator:function(){rl.isNonNullStr(this._lastSortingId)&&rl.$(this._lastSortingId).removeClass("sorting").removeClass("asc").removeClass("dec")},resetSortIndicator:function(){},_isCellEle:function(t){try{return"td"==t.tagName.toLowerCase()&&t.id.contains(this.id)}catch(e){}},afterAllSelectStateChange:function(t){this.updateSelectStateView(t)},getCols:function(){return this.grid.cols},hideCol:function(t){this.head.hideCol(t)},showCol:function(t){this.head.showCol(t)},scrollToX:function(t){var e=this.dw.getDom().parentNode;e.style.left=t+"px"},hndMouseover:function(t){var e=this.getCellEleByChild(rl.ew.init(t).getTarget());rl.$(e).addClass("over")},hndMouseout:function(t){var e=this.getCellEleByChild(rl.ew.init(t).getTarget());rl.$(e).removeClass("over")},hndClick:function(t){if(!this._lastMousedown2Resizer){var e=rl.ew.init(t).getTarget();if(!this._isResizer(e)){var i=this.getCellEleByChild(e);if(i){var r=this.getIndexFromCellEle(i),s=this.cols[r];if(e.tagName.equalsIgnoreCase("input")){if(!e.type.equalsIgnoreCase("checkbox"))return;if(s&&s.bindRowSelectAction){var n=e.checked,o=this.grid;n?o.selectAll():o.unSelectAll()}}else s&&s.sortable!==!1&&(this._sortingIndex==r?this.isAscSort=!this.isAscSort:(this._sortingIndex=r,this.isAscSort=!0),this.grid.sort(r,this.isAscSort))}}}},hndDblclick:function(t){var e=rl.ew.init(t).getTarget();if(this._isResizer(e)){var i=this.getCellEleByChild(e);i&&this.grid.fitColContentWidth(this.getIndexFromCellEle(i))}},hndDndResizeB4Start:function(){var t=rl.ew.getTarget();if(this._lastMousedown2Resizer=!1,!this._isResizer(t))return!1;this._lastMousedown2Resizer=!0;var e,i=this.getCellEleByChild(t),r=this.getIndexFromCellEle(i),s=this.cols[r];return s&&s.resizable?(e=rl.dom.getOffsetX(t,this.dw.getDom().parentNode)+t.scrollWidth,this._dndMoveStartDataStore={X:e,colIndex:r,colWidth:rl.$(i).getWidth()-10,clientX:rl.ew.clientX()},void this.grid.setResizingIndicatorX(e)):!1},hndDndResizing:function(){var t=this._dndMoveStartDataStore;if(t){var e,i=rl.ew.clientX()-t.clientX;i>-t.colWidth&&(e=t.X+i,t.chgX=i,this.grid.setResizingIndicatorX(e))}},hndDndResized:function(){var t=this._dndMoveStartDataStore;if(t){var e=this.grid,i=t.colWidth+t.chgX;isNaN(i)||e.setColWidth(t.colIndex,i),e.hideResizingIndicator(),delete this._dndMoveStartDataStore}},_isResizer:function(t){var e=rl.$(t);return e.isTag("span")&&e.hasClass("resizer")},toString:function(){return"[object rl.gui.grid.Head]"}}})}(),function(){rl.gui.grid.Body=rl.createClass({parent:rl.gui.ContainerBase,construct:function(t){rl.isPrototyping(arguments[0])||(rl.gui.grid.Body.parent.call(this,t),this.dw=new rl.DomWrap,this.rows=[],this._namedItemsStore={},this._selectedRows=[])},members:{rowType:rl.gui.grid.Row,renderTarget:null,rowClickAction:null,rowDblClickAction:null,stripeRows:!0,clickToSelect:!0,sortField:"",cols:void 0,rows:void 0,_htmlTpl:new rl.HtmlTpl('<table class="rows_wrap" border="0" cellspacing="0" cellpadding="0">{rowsHtml}</table>'),load:function(){for(var t,e=this.id+"_",i=this.rows,r=this.rowType,s=this.grid.dataSource,n=s.rows,o=0,l=n.length;l>o;o++)t=new r({owner:this,dataSource:n[o],rowIndex:o,id:e+o}),i.push(t)},render:function(t){if(this._rendered)return this;t=this.getRenderTarget(t);var e=this.getRowsRenderHtml();return t.innerHTML=this._htmlTpl.assign({rowsHtml:e}),this.dw.setTarget(t.firstChild),this.afterRender(),this.renderComponents(),this._rendered=!0,this.fireEvent("render"),this},reRender:function(t){return this._rendered=!1,this.render(t)},getRowsRenderHtml:function(){var t=Array.map(function(t){return t.getRenderHtml()},this.rows);return t.join("")},afterRender:function(){Array.each(function(t){t.afterRenderByOwner()},this.rows);var t=this.dw;t.on("mousedown",this.hndMousedown,this),t.on("mouseover",this.hndMouseover,this),t.on("click",this.hndClick,this),t.on("dblclick",this.hndDblClick,this)},renderComponents:function(){var t=[],e=this.cols;Array.each(function(e){e.cellCompType&&e.cellCompType.prototype instanceof rl.gui.ComponentBase&&t.push(e)},e),t.length&&Array.each(function(e){Array.each(function(t){e.createColComponent(t)},t)},this.rows),this.fireEvent("componentsRender")},setRowHeight:function(t,e){var i=this.rows[t];i&&i.setHeight&&i.setHeight(e)},setWidth:function(){return this},setHeight:function(){return this},getSelectedItems:function(){return this._selectedRows},getItems:function(){return this.rows},getNamedItemStore:function(){return this._namedItemsStore},hideRow:function(t){var e=this.rows[t];e&&e.hide&&e.hide()},showRow:function(t){var e=this.rows[t];e&&e.show&&e.show()},hideCol:function(t){this.each(function(e){e.hideCell(t)})},showCol:function(t){this.each(function(e){e.showCell(t)})},setColWidth:function(t,e){this.each(function(i){i.setCellWidth(t,e)}),this.grid.hndBodyScroll()},getColMaxContentWidth:function(t){var e=0;return this.each(function(i){e=Math.max(i.getCellContentWidth(t),e)}),e},sort:function(t,e){t=this.grid.toField(t),e=!!e;var i,r=this.grid.getCol(t);if(r){if(this.sortField==t){if(this.isAscSort==e)return;this.rows.reverse()}else this.sortField=t,this._doSort();this.isAscSort=e;try{i=document.getElementById(this.rows[0].id).parentNode}catch(s){}if(i){var n=document.createDocumentFragment();this.each(function(t,e){t.setRowIndex(e),n.appendChild(t.dw.getDom())}),i.appendChild(n),n=null}}},_doSort:function(){var t,e,i,r=this.rows,s=this.rows=[];this.grid.dataSource.each(function(n){for(t=0,e=r.length;e>t;t++)if(i=r[t],i.dataSource==n)return s.push(i),void r.removeAt(t)},this)},afterAllSelectStateChange:function(t){this.fireEvent("allSelectStateChange",t)},afterRowChange:function(){this.updateRowsIndexFrom(0),this.checkAllSelectedState()},beforeAdd:function(t){return t instanceof this.rowType?!0:!1},afterAdd:function(t){var e=this._getItemsCtn();rl.isElement(e)&&t.appendDomTo(e),t.owner&&t.owner.remove(t),t.owner=this,this.afterRowChange(t,"add")},afterRemove:function(t){rl.isFunction(t.unSelect)&&t.unSelect(),delete t.owner,t.removeDom(),this.afterRowChange(t,"remove")},sendSelected:function(t){if(this.remoteUpdate){var e=this.getSelectedItemsDataIdList();if(!rl.isArray(e)||!e.length)return;var i=this.encodeSelectedDataIdList2QS();rl.debug("qs = "+i),this.grid.load({url:t,dynamicParams:i})}else rl.debug("removeSelectedRows = "+this.remoteUpdate)},encodeSelectedDataIdList2QS:function(){var t=this.getSelectedItemsDataIdList();if(rl.isArray(t)&&t.length){var e={},i=this.selectorColField;return e[i]=t,rl.data.encode2QS(e)}},updateRowsIndexFrom:function(t){var e,i,r,s=this.rows;for(t=parseInt(t),isNaN(t)&&(t=0),e=t,i=s.length;i>e;e++)r=s[e],r.setRowIndex(e)},clear:function(){var t=this.dw;this.each(function(t){this.afterRemove(t),t.dispose()},this),this.rows=[],this._namedItemsStore={},this._selectedRows=[],delete this._lastMouseoverTarget,delete this._lastFocusedRow,delete this._lastMouseoverRow,this.checkAllSelectedState(),t.un("mousedown",this.hndMousedown,this),t.un("mouseover",this.hndMouseover,this),t.un("click",this.hndClick,this),t.un("dblclick",this.hndDblClick,this),t.dispose()},insertRow:function(){},getDataSourceIdFieldName:function(){return this.grid.dataSource.primaryKey},getCellCoordsByEle:function(t){if(!rl.isElement(t))return null;var e=this.getItemByEle(t);if(!e)return null;var i=e.getCellEleByChild(t),r=e.getIndexFromCellEle(i);return{X:r,Y:e.rowInex}},getCellCoordsByEvent:function(t){var e=rl.ew.init(t).getTarget();return this.getCellCoordsByEle(e)},getColByEle:function(t){var e=this.getCellCoordsByEle(t);return e?this.cols[e.X]:void 0},_getItemsCtn:function(){return this.dw.dom.firstChild},hndMousedown:function(t){var e=rl.ew.init(t);e.shiftKey()&&e.stopEvent()},hndMouseover:function(t){this.trackMouseover&&(this._lastMouseoverTarget=rl.ew.init(t).getTarget(),window.clearTimeout(this._doTrackMouseoverTimer),this._doTrackMouseoverTimer=Function.delay(this.doTrackMouseover,15,this))},doTrackMouseover:function(){var t=this.getItemByEle(this._lastMouseoverTarget);t&&(this._lastMouseoverRow&&this._lastMouseoverRow.owner==this&&this._lastMouseoverRow.applyInteractiveStyle("out"),this._lastMouseoverRow=t,t.applyInteractiveStyle("over"))},hndClick:function(t){var e=this.getItemByEvent(t);if(e){var i,r=rl.ew.init(t).getTarget(),s=rl.$(r).isTag("input"),n=rl.ew.ctrlKey(),o=rl.ew.shiftKey(),l=(r.type||"").toLowerCase(),a=this.getColByEle(r);if(i=s&&a&&("checkbox"==l||"radio"==l))a&&a instanceof this.grid.selectorColType&&("checkbox"==l?r.checked?this.selectItem(e):this.unSelectItem(e):this.selectSingle(e));else if(this.clickToSelect)if(this.grid.enbaleMultiSelect&&(n||o))if(o){var d=this._lastFocusedRow||this.rows[0];if(d!=e){var h=Math.min(d.rowIndex,e.rowIndex),c=Math.max(d.rowIndex,e.rowIndex)+1;this.unSelectAll();for(var u=h;c>u;u++)this.selectItem(u)}else this.selectSingle(e)}else this.toggleSelectItem(e);else this.selectSingle(e);o||(this._lastFocusedRow&&this._lastFocusedRow.owner==this&&this._lastFocusedRow.blur(),this._lastFocusedRow=e,e.focus()),rl.isFunction(this.rowClickAction)&&this.rowClickAction(e),this.fireEvent("rowclick",e)}},hndDblClick:function(t){var e=this.getItemByEvent(t);e&&(rl.isFunction(this.rowDblClickAction)&&this.rowDblClickAction(e),this.fireEvent("rowdblclick",e))},onDispose:function(){this.clear()},toString:function(){return"[object rl.gui.grid.Body]"}}}),rl.fill(rl.gui.grid.Body.prototype,rl.gui.itf.iItemsSelectable)}(),function(){rl.gui.grid.Column=rl.createClass({parent:rl.data.Column,construct:function(t){rl.isPrototyping(arguments[0])||rl.gui.grid.Column.parent.call(this,t)},members:{caption:"&nbsp;",cellCompType:null,getCellCompConfig:null,convert:null,displayIndex:0,name:"",sortable:!0,sortType:"",resizable:!0,visible:!0,hidable:!0,width:"auto",minWidth:20,maxWidth:1024,headCss:"",cellCss:"",toString:function(){return"[object rl.gui.grid.Column]"}}}),rl.gui.ctype2Classes.add("Column",rl.gui.grid.Column)}(),function(){rl.gui.grid.RowNumberer=rl.createClass({parent:rl.gui.grid.Column,construct:function(t){rl.isPrototyping(arguments[0])||rl.gui.grid.RowNumberer.parent.call(this,t)},members:{caption:"",displayIndex:0,sortable:!0,sortType:"",resizable:!1,hidable:!0,headCss:"row_numberer",cellCss:"row_numberer",width:"auto",convert:function(t,e,i){return i+1},toString:function(){return"[object rl.gui.grid.RowNumberer]"}}}),rl.gui.ctype2Classes.add("RowNumberer",rl.gui.grid.RowNumberer)}(),function(){rl.gui.grid.RowSelector=rl.createClass({parent:rl.gui.grid.Column,construct:function(t){rl.isPrototyping(arguments[0])||(rl.gui.grid.RowSelector.parent.call(this,t),this.initSelectorHtml())},members:{selectorName:"rowSelector",asRowSelector:!0,multiple:!0,bindRowSelectAction:!0,sortable:!1,resizable:!1,hidable:!1,width:23,initSelectorHtml:function(){var t=this.multiple?"checkbox":"radio",e=' style="'+(rl.GECKO?"width:20px;":"")+'vertical-align:middle;"';this._selectorHtml='<div style="text-align:center;"><input '+e+' type="'+t+'" name="'+this.selectorName+'" />&nbsp;</div>'},convert:function(){return this._selectorHtml},convertCaption:function(t){return this.multiple?this._selectorHtml:t},toString:function(){return"[object rl.gui.grid.RowSelector]"}}}),rl.gui.grid.defaultRowSelectorType=rl.gui.grid.RowSelector,rl.gui.ctype2Classes.add("RowSelector",rl.gui.grid.RowSelector)}(),function(){var t=rl.getG11nSource("rl.gui.grid.PagingBar")||{};rl.gui.grid.PagingBar=rl.createClass({parent:rl.gui.menu.ToolBar,construct:function(t){rl.isPrototyping(arguments[0])||rl.gui.grid.PagingBar.parent.call(this,t)},members:{autoRenderOnReady:!1,dataSource:null,extraItems:null,emptyMessage:"",loadDataBeforeRender:!1,limitSelectedIndex:0,limitItems:null,iniHeight:26,showRecordsInfo:!0,showPagingNav:!0,showPagingPos:!0,showPageTotal:!0,showPagingLimit:!0,initialize:function(){if(rl.isNonNullStr(this.id)||(this.id=this.autoId()),!rl.isArray(this.items)){this.showPagingLimit&&!this.limitItems&&(this.limitItems=rl.gui.grid.PagingBar.normalItemOptions.limitItems);var t=this.createNormalItems();rl.isArray(this.extraItems)&&(t=t.concat(this.extraItems)),this.items=t}this.initDataSource(),rl.gui.grid.PagingBar.parent.prototype.initialize.apply(this,arguments)},createNormalItems:function(){var e,i,r=[],s=rl.pm.setRoot(rl.gui.imgPM.mapping("grid/")),n=this.dataSource,o=Function.bind,l=rl.gui.grid.PagingBar.normalItemOptions;return this.showPagingNav&&(r.push({id:this.id+"first",icon:s.mapping("go_first.gif"),disabledIcon:s.mapping("go_first_disabled.gif"),action:o(n.loadFirst,n)}),r.push({id:this.id+"pre",icon:s.mapping("go_pre.gif"),disabledIcon:s.mapping("go_pre_disabled.gif"),action:o(n.loadPrevious,n)})),this.showPagingPos&&(i=new rl.gui.form.Input({id:this.id+"pagingPos",label:l.posLabelL,width:30,annotation:l.posLabelR,autoRenderOnReady:!1,value:1}),i.on("enter",this.hndPosPressEnter,this),r.push(i)),this.showPageTotal&&r.push(new rl.gui.form.Label({id:this.id+"pageTotal",textRender:l.pageTotalTextRender,autoRenderOnReady:!1,text:"1"})),this.showPagingNav&&(r.push({id:this.id+"next",icon:s.mapping("go_next.gif"),disabledIcon:s.mapping("go_next_disabled.gif"),action:o(n.loadNext,n)}),r.push({id:this.id+"last",icon:s.mapping("go_last.gif"),disabledIcon:s.mapping("go_last_disabled.gif"),action:o(n.loadLast,n)}),r.push(new rl.gui.menu.MenuSplit(" "))),this.showPagingLimit&&(e=new rl.gui.form.Combox({id:this.id+"limitSelect",label:l.limitLabelL,annotation:l.limitLabelR,selectedIndex:this.limitSelectedIndex,autoRenderOnReady:!1,items:this.limitItems}),rl.debug(this+" this.limitItems = "+this.limitItems),e.on("change",this.hndLimitChange,this),r.push(e)),this.showRecordsInfo&&r.unshift({id:this.id+"recordsInfo",ctype:"Label",alignRight:!0,text:n.pagingRecordsTotal,textRender:Function.bind(function(e){var i=this.dataSource,r=i.pagingRecordStart,s=i.pagingRecordEnd,n=this.emptyMessage,o=(this.recordsTotalTextRender||t.recordsTotalTextRender||rl.EMPTY_FUNCTION)(e);if(e>0)rl.isNumber(r)&&rl.isNumber(s)&&(o=t.displaying+r+" - "+s+", "+o);else if(rl.isNonNullStr(n))return n;return o},this)}),r},initDataSource:function(){var t=this.dataSource;if(t.on("load",this.hndDataLoad,this),this.showPagingLimit){var e=this.limitItems[this.limitSelectedIndex];t.setPagingLimit(e.value||e.text)}},hndDataLoad:function(){var t=this.dataSource;if(t){var e=t.pagingPosition,i=t.getPagingTotalPages();if(0===i)e=i;else if(e>i)return void Function.defer(t.loadLast,t);if(this.showPagingNav){var r=this.getItemById(this.id+"first"),s=this.getItemById(this.id+"pre"),n=this.getItemById(this.id+"next"),o=this.getItemById(this.id+"last");e<=t.pagingFisrt?(r.disable(),s.disable()):(r.enable(),s.enable()),e==t.getPagingTotalPages()?(o.disable(),n.disable()):(o.enable(),n.enable())}if(this.showPagingNav){var l=this.getItemById(this.id+"pageTotal");l.setText(i)}if(this.showPagingPos){var a=this.getItemById(this.id+"pagingPos");a.setValue(e)}if(this.showRecordsInfo){var d=this.getItemById(this.id+"recordsInfo");d.setText(t.pagingRecordsTotal)}}},hndLimitChange:function(){var t=this.dataSource,e=this.getItemById(this.id+"limitSelect");rl.debug("limitSelect.value = "+e.value),t.setPagingLimit(e.value,!0)},hndPosPressEnter:function(){var t=this.dataSource,e=this.getItemById(this.id+"pagingPos");t.loadPage(parseInt(e.getValue()))},toString:function(){return"[object rl.gui.grid.PagingBar]"}}}),function(){rl.gui.grid.PagingBar.normalItemOptions={posLabelL:t.posLabelL,posLabelR:t.posLabelR,limitLabelL:t.limitLabelL,limitLabelR:t.limitLabelR,limitItems:[{text:"20",value:20},{text:"50",value:50},{text:"100",value:100},{text:"200",value:200}],pageTotalTextRender:t.pageTotalTextRender}}()}();var t=rl.getG11nSource("rl.gui.grid.Grid")||{};rl.gui.grid.Grid=rl.createClass({parent:rl.gui.ContainerBase,construct:function(t){rl.isPrototyping(arguments[0])||(rl.gui.grid.Grid.parent.call(this,t),this.initialize())},members:{localSort:!0,loadDataBeforeRender:!0,autoRenderOnReady:!0,iniSelectRows:void 0,clickToSelect:!0,stripeRows:!0,deferRenderBody:!0,trackMouseover:!0,dataSource:null,showPagingBar:!0,autoMemory:!0,readDataErrHandler:null,pagingBar:null,emptyMessage:t.emptyMessage||"Empty list",placeHolder:"",cellEmptyText:"",colType:rl.gui.grid.Column,selectorColType:rl.gui.grid.RowSelector,selectorColField:"",id:"",renderTarget:null,_headHeight:24,theme:"",maxiWidth:1e4,miniWidth:200,maxiHeight:2e3,miniHeight:100,cols:void 0,autoFitColumnsWidth:!0,forceFit:!1,firstSortField:"",pbOptions:null,remoteUpdate:!0,resizeIndicatorTip:t.resizeIndicatorTip||"resize",MSG_READ_DATA_ERR:rl.getG11nSource("READ_DATA_ERR")||"Read data error!",_htmlTpl:new rl.HtmlTpl('<div id="{id}" class="rl_grid {theme}"><div class="rl_grid_head"><div class="row_wrap"></div></div><div class="rl_grid_body" style="height:{bodyHeight};"></div><div class="rl_grid_pagingbar"></div><div class="resize_indicator" id="{resizeIndicatorId}">&nbsp;</div><div class="grid_mask" id="{gridMaskId}">'+(rl.IE&&rl.VER_IE<7?'<div class="grid_mask"></div><iframe class="grid_mask" src="about:blank"></iframe>':"&nbsp;")+"</div></div>"),initialize:function(){var t=this.id,e=this.cols=[],i=this._filedIndexMapping=[],r=this.colType,s=rl.gui.grid.defaultRowSelectorType;t||(t=this.id=this.autoId()),this.resizeIndicatorId=t+"_resizeIndicator",this.gridMaskId=t+"_gridMask",Array.each(function(t,n){rl.isObject(t)&&(t instanceof r||(t=new(rl.gui.getCompType(t.ctype)||r)(t)),t instanceof s&&t.asRowSelector&&(this.selectorColField=t.selectorName),t.displayIndex=n,e.push(t),i.push(t.name))},this.columns,this),delete this.columns,this.dw=new rl.DomWrap,rl.gui.compStore.add(this.id,this),this.initDataSource(),this.createHead(),this.createBody(),this.showPagingBar&&this.createPagingBar();var n=this.iniSelectRows;(rl.isArray(n)||rl.isFunction(n))&&(this.isIniSelectRow=rl.isArray(n)?Function.bind(function(t){var e=this.dataSource.primaryKey;return this.iniSelectRows.contains(t.getValue(e))},this):n,this.body.on("render",this.doAutoSelectRows,this)),this.autoRenderOnReady&&rl.onReady(Function.bind(this.render,this))},createHead:function(){var t=rl.gui.grid,e=this.id,i=this.cols;this.head=new t.Head({grid:this,cols:i,id:e+"_head"})},createBody:function(){{var t=rl.gui.grid,e=this.id,i=this.cols;this.dataSource}this.body=new t.Body({grid:this,cols:i,stripeRows:this.stripeRows,clickToSelect:this.clickToSelect,trackMouseover:this.trackMouseover,remoteUpdate:this.remoteUpdate,selectorColField:this.selectorColField,rowClickAction:this.rowClickAction,rowDblClickAction:this.rowDblClickAction,id:e+"_body"}),this.body.on("allSelectStateChange",this.hndRowsAllSelectStateChange,this),this.body.on("render",this.hndBodyRender,this)},createPagingBar:function(){if(!this.pagingBar){var t=rl.gui.grid,e=this.dataSource;this.pagingBar=new t.PagingBar(rl.fill({loadDataBeforeRender:!1,dataSource:e,emptyMessage:this.emptyMessage,autoRenderOnReady:!1},this.pbOptions))}},load:function(t){this.dataSource.load(t)},initDataSource:function(){var t=this.dataSource;t.on("sort",this.hndDataSort,this),t.on("beginload",this.hndDataBeginLoad,this),t.on("load",this.hndDataLoad,this),t.on("remove",this.hndDataRemove,this),t.on("clear",this.clear,this),t.on("readrequesterror",this.hndDataReadErr,this)},doAutoSelectRows:function(){var t=this.body;Array.each(function(e){var i=e.dataSource;this.isIniSelectRow(i)&&t.selectItem(e)},t.rows,this)},clear:function(){this.body.clear()},render:function(t){if(this.loadDataBeforeRender)return this.loadDataBeforeRender=!1,this._loadingDataForRender=!0,this.load(),this;if(this._loadingDataForRender)return this;if(this._rendered)return this;t=this.getRenderTarget(t);var e,i,r=(rl.dom.addUnit,this.id),s=parseInt(t.style.height,10),n=this._getPagingBarHeight(),o=function(){this.body.render(this.bodyWrap)};if(s>0||(s=0),e=s-this._headHeight-n,rl.debug(this+" render(): bodyHeight = "+e),i=this._htmlTpl.renderTo(t,{id:r,theme:this.theme,resizeIndicatorId:this.resizeIndicatorId,gridMaskId:this.gridMaskId,bodyHeight:rl.dom.addUnit(e)},this.renderPosition),this.dw.setTarget(i),this.calColumnsWidth(),rl.isNonNullStr(this.placeHolder)){var l=rl.getDom(this.placeHolder);rl.isElement(l)&&rl.$(l).hide()}var a=i.firstChild,d=a.firstChild;return this.bodyWrap=a.nextSibling,rl.$(this.bodyWrap).on("scroll",this.hndBodyScroll,this),this.head.render(d),this.pagingBar?this.pagingBar.appendDomTo(this.bodyWrap.nextSibling):rl.$(this.bodyWrap.nextSibling).hide(),this.deferRenderBody?Function.defer(o,this):o.call(this),this._rendered=!0,this.fireEvent("render"),this},calColumnsWidth:function(){var t,e=this.dw.getWidth(),i=!this.autoFitColumnsWidth;Array.each(function(r){t=r.width,/\%/.test(t)&&i&&(t=e*parseInt(t)/100,r.width=t)},this.cols,this)},sort:function(t,e){return t=this.toField(t),t&&this.dataSource.sort(t,e),this},setWidth:function(t){return t=parseInt(t),!this._rendered||isNaN(t)||this.width==t?this:(t>this.maxiWidth?t=this.maxiWidth:t<this.miniWidth&&(t=this.miniWidth),this.width=t,this.dw.setWidth(t),this)},setHeight:function(t){if(t=parseInt(t),!this._rendered||isNaN(t)||this.height==t)return this;if(t>this.maxiHeight?t=this.maxiHeight:t<this.miniHeight&&(t=this.miniHeight),this.height=t,this.dw.setHeight(t),this.body){var e=this.body.dw.dom;if(rl.isElement(e)&&rl.isElement(e.parentNode)){var i=t-this._headHeight-this._getPagingBarHeight();rl.$(e.parentNode).setHeight(i)}}return this},getHeight:function(){return this.height},setTheme:function(t){var e=this.theme;return rl.isNonNullStr(t)&&t!=e&&(this.dw.removeClass(e).addClass(t),this.theme=t,this.fireEvent("themeChange",t,e)),this},_getPagingBarHeight:function(){if(!isNaN(this._pagingBarHeight))return this._pagingBarHeight;var t=0;return this.showPagingBar&&(t=parseInt(this.pagingBar.iniHeight),isNaN(t)&&(t=0)),this._pagingBarHeight=t,t},fitColContentWidth:function(t){var e=this.getCol(t);if(!e||!e.resizable)return this;var i=this.toIndex(t);return t=this.toField(t),this.setColWidth(i,this.getColMaxContentWidth(i)),this},doAutoFitColumnsWidth:function(){var t=/auto/i;return Array.each(function(e,i){if(t.test(e.width)||!(e.width>0)){var r=this.getColMaxContentWidth(i);this.head.setCellWidth(i,r),this.body.setColWidth(i,r)}},this.cols,this),this},getColMaxContentWidth:function(t){return Math.max(this.head.getCellContentWidth(t),this.body.getColMaxContentWidth(t))},setColWidth:function(t,e){var i=this.getCol(t);return i&&i.width!=e?(this.head.setCellWidth(t,e),this.body.setColWidth(t,e),i.width=e,this):this},setColCaption:function(t,e){var i=this.getCol(t);return i?(t=this.toIndex(t),this.head.setCaption(t,e),i.caption=e,this):this},setResizingIndicatorX:function(t){rl.$(this.resizeIndicatorId).setLeft(t)},hideResizingIndicator:function(){rl.$(this.resizeIndicatorId).setLeft(-100)},toField:function(t){return isNaN(t)?t:this._filedIndexMapping[t]},toIndex:function(t){return rl.isNonNullStr(t)?this._filedIndexMapping.indexOf(t):isNaN(t)?-1:t},getCol:function(t){var e=this.cols;return rl.isNonNullStr(t)&&(t=this.toIndex(t)),e[t]},hndRowsAllSelectStateChange:function(t){this.head.afterAllSelectStateChange(t)},sendSelected:function(t){return this._svFlagDeleteAction=!0,this.body.sendSelected(t)},getSelectedRows:function(){return this.body.getSelectedItems()},getSelectedRowsIdList:function(){return this.body.getSelectedItemsDataIdList()},selectAll:function(){return this.body.selectAll()},unSelectAll:function(){return this.body.unSelectAll()},showMask:function(){var t=rl.getDom(this.gridMaskId);t&&rl.$(t).show()},hideMask:function(){var t=rl.getDom(this.gridMaskId);t&&rl.$(t).hide()},hideCol:function(t){var e=this.cols[t];e&&e.visible&&(this.body.hideCol(t),this.head.hideCell(t),e.visible=!1)},showCol:function(t){var e=this.cols[t];e&&!e.visible&&(this.body.showCol(t),this.head.showCell(t),e.visible=!0,this.fitColContentWidth(t))},hndBodyRender:function(){this.autoFitColumnsWidth&&Function.defer(this.doAutoFitColumnsWidth,this)},hndBodyScroll:function(){var t=this.bodyWrap;this.head.scrollToX(-t.scrollLeft)},hndDataSort:function(){var t=this.dataSource,e=this.sortField=t.sortField,i=this.isAscSort=t.isAscSort;this.body.sort(e,i),this.head.afterSort(e,i)},hndDataBeginLoad:function(){this.showMask(this.loadingTip)},hndDataLoad:function(){return this._svFlagDeleteAction?(this._svFlagDeleteAction=!1,void Function.defer(this.load,this)):(this.body.load(),this.dataSource.autoSort||(this.sortField=null,this.body.sortField=null,this.dataSource.localSort&&(this.head.hideSortIndicator(),this.head.resetSortIndicator())),this._rendered?(this.body.reRender(this.bodyWrap),this.bodyWrap.scrollTop=0):(this._loadingDataForRender=!1,this.render()),void this.hideMask())
},hndDataRemove:function(){},hndDataReadErr:function(t){var e=this.readDataErrHandler||rl.gui.grid.gridReadDataErrHandler;if(this.hideMask(),!rl.isFunction(e)||e.call(this,t)!==!0){var i=this.MSG_READ_DATA_ERR+((t||rl.EMPTY_OBJECT).description||"");rl.dir(t,"hndDataReadErr() e"),rl.BEFORE_UNLOAD||alert(i)}},onDispose:function(){delete this.bodyWrap,delete this.renderTarget,this.head.dispose(),this.body.dispose(),this.dw.dispose()},toString:function(){return"[object rl.gui.grid.Grid]"}}}),rl.Grid=rl.gui.grid.Grid,rl.gui.ctype2Classes.add("grid",rl.gui.grid.Grid)});