/**
 * @fileOverview Rows data mgr.
 * @change
 	#1 by prcjack Creates file.
 	#2 by prcjack @2014/03/02 Add remote sort support.
 	#3 by prcjack @2014/04/01 Remove pagingbar options.
 */
orderjs.define("lib.data.Table",["lib.data.engine"],function(){rl.data.Record=rl.createClass({parent:rl.util.EventProvider,construct:function(t){rl.isPrototyping(arguments[0])||(rl.data.Record.parent.call(this,t),this._data=t)},members:{owner:null,modified:!1,_editing:!1,_chgMemo:null,getValue:function(t){return this._data[t]},getValues:function(t,e){if(!t)return void rl.debug(this+" -> getValues(): Invalid arguments!","warn");var i;return rl.isNonNullStr(t)&&(t=t.split(",")),e?(i={},Array.each(function(t){i[t]=this.getValue(t)},t,this)):i=Array.map(this.getValue,t,this),i},getAll:function(){return this._data},setValue:function(t,e){if(!rl.isNonNullStr(t))return this;var i=this._data,r=i[t];return r==e?this:(void 0!==r&&(this._chgMemo||(this._chgMemo={}),this._chgMemo[t]=r),i[t]=e,this._editing||(this.owner&&this.owner.afterRowEdit(this),this.fireEvent("change",rl.data.Record.ChangeTypes.EDIT,t,e,r)),this.modified=!0,this)},setValues:function(t){this.beginEdit();for(var e in t)this.setValue(e,t[e]);return this.endEdit(),this},setRawData:function(t){this.rawData=t},getRawData:function(){return this.rawData},commit:function(){return this.modified=!1,delete this._chgMemo,this._editing=!1,this.owner&&this.owner.afterRowCommit(this),this.fireEvent("change",rl.data.Record.ChangeTypes.COMMIT),this},reject:function(){if(!this.modified)return this;var t,e=this._chgMemo;for(var i in e)t=e[i],rl.isFunction(t)||this.setValue(i,t);return this.modified=!1,this._editing=!1,delete this._chgMemo,this.owner&&this.owner.afterRowReject(this),this.fireEvent("change",rl.data.Record.ChangeTypes.REJECT),this},clone:function(){return new this.constructor(this._data)},toQueryString:function(){return rl.data.encode2QS(this._data)},toFormString:function(){return rl.data.encode2FS(this._data)},beginEdit:function(){this._editing=!0},endEdit:function(){this._editing=!1,this.modified&&(this.owner?this.owner.afterRowEdit(this):this.fireEvent("change",rl.data.Record.ChangeTypes.EDIT))},cancelEdit:function(){this._editing=!1},setLoadState:function(t){this._loadState=t},getLoadState:function(){return this._loadState},isDeprecated:function(){return this._loadState==rl.data.Record.LoadStates.UNCHANGED},toString:function(){return"[object rl.data.Record]"}}}),rl.data.Record.ChangeTypes={EDIT:1,COMMIT:2,REJECT:3},rl.data.Record.LoadStates={ADDED:1,UPDATED:2,UNCHANGED:3},rl.data.Row=rl.createClass({parent:rl.data.Record,construct:function(t){rl.isPrototyping(arguments[0])||rl.data.Row.parent.call(this,t)},members:{toString:function(){return"[object rl.data.Row]"}}}),rl.data.ConvertTypes={ipRe:/^([1]\d\d|[2][0-5][0-5]|[1-9]\d|\d)\.([1]\d\d|[2][0-5][0-5]|[1-9]\d|\d)\.([1]\d\d|[2][0-5][0-5]|[1-9]\d|\d)\.([1]\d\d|[2][0-5][0-5]|[1-9]\d|\d)/,floatRe:/^[+-]?\d+(\.\d+)?$/,intRe:/^[+-]?\d+(\.\d+)?$/,dateRe:/^(\d\d?)[\/\.-](\d\d?)[\/\.-]((\d\d)?\d\d)$/,guessConvert:function(t){var e,i=rl.data.ConvertTypes;return i.ipRe.test(t)?e="toIP":i.floatRe.test(t)?e="toFloat":i.intRe.test(t)?e="toInt":i.dateRe.test(t)&&(e="toDate"),i[e]},fillIp:function(t){return t="00"+t,t.substr(t.length-3)},toUCString:function(t){return String(t).toUpperCase()},toIP:function(t){if(!rl.data.ConvertTypes.ipRe.test(t))return t;var e=rl.data.ConvertTypes.fillIp,i=parseFloat(e(RegExp.$1)+e(RegExp.$2)+e(RegExp.$3)+e(RegExp.$4));return i},toDate:function(t){return t?t instanceof Date?t.getTime():Date.parse(String(t)):0},toFloat:function(t){var e=parseFloat(String(t).trim());return isNaN(e)&&(e=0),e},toInt:function(t){var e=parseInt(String(t).trim());return isNaN(e)&&(e=0),e},toString:function(){return"[object rl.data.ConvertTypes]"}},rl.data.Column=rl.createClass({construct:function(t){rl.isPrototyping(arguments[0])||(rl.isNonNullStr(t)&&(t={name:t}),rl.ext(this,t))},members:{name:"",sortable:!0,convert:!1,convertType:"auto",sortConvert:!0,sortFunction:null,sortConvertType:"auto",mapping:null,defaultValue:"",initConvert:function(t){if(this.convert!==!1&&!rl.isFunction(this.convert)){var e=this.convertType,i=rl.data.ConvertTypes;this.convert="auto"==e?i.guessConvert(t):i[e]}},initSortConvert:function(t){if(this.sortConvert!==!1&&!rl.isFunction(this.sortConvert)){var e=this.sortConvertType,i=rl.data.ConvertTypes;this.sortConvert="auto"==e?i.guessConvert(t):i[e]}},toString:function(){return"[object rl.data.Column]"}}}),rl.data.Table=rl.createClass({parent:rl.util.EventProvider,construct:function(t){if(!rl.isPrototyping(arguments[0])){rl.ext(this,t),rl.data.Table.parent.call(this,t),this._chgMemo=[],this.rows=[],this.cols=[],this._selectedRows=[];var e,i=this.cols,r=this.colType||rl.data.Table.DefaultColumnType;Array.each(function(t){e=new r(t),i.push(e),e.mapping||0===e.mapping||(e.mapping=e.name)},this.dataVisitor.fields),this.initReq()}},members:{primaryKey:"",httpRequest:null,dataVisitor:null,clearMode:"all",readMode:"specified",cacheRawData:!1,uniqueCheck:!0,localSort:!0,autoSort:!1,sortable:!0,defaultSortField:0,defaultAscSort:!0,colType:null,rowType:null,pagingLimit:50,pagingFisrt:1,pagingPosition:1,pagingRecordsTotal:void 0,pagingPagesTotal:void 0,reqPagingPosition:"current",reqPagingLimit:"limit",reqSortOrder:"order",reqSortField:"sortColumn",modified:!1,load:function(t,e){this.fireEvent("beforeload",t,e)!==!1&&(this.fireEvent("beginload",t,e),this.httpRequest?e?this.readRequest():(t=t||{},t.dynamicParams=this.getDynamicParams(t.dynamicParams),this.updateRequest(t)):this._read())},getDynamicParams:function(t){var e=this.reqPagingLimit,i=this.reqPagingPosition,r=this.reqSortOrder,a=this.reqSortField;return rl.isNonNullStr(t)&&(t=rl.data.decodeQS(t)),rl.isObject(t)||(t={}),rl.isDefined(t[e])||(t[e]=this.pagingLimit),rl.isDefined(t[i])||(t[i]=this.pagingPosition),this.localSort||(rl.isDefined(t[r])||(t[r]=this.isAscSort?"asc":"desc"),rl.isDefined(t[a])||(t[a]=this.sortField||"")),rl.data.encode2QS(t)},getFields:function(){var t=this.dataVisitor;return t&&t.fields?Array.map(function(t){return t.name},t.fields):null},loadPage:function(t){var e,i=this.getPagingTotalPages(),r=this.pagingFisrt;0!==i&&(isNaN(i)&&(i=r),isNaN(t)||r>t?t=r:t>i&&(t=i),this.pagingPosition!=t&&(this.pagingPosition=t,e=this.reqPagingPosition+"="+t,this.load({dynamicParams:e})))},loadFirst:function(){this.loadPage(this.pagingFisrt)},loadPrevious:function(){var t=this.pagingPosition||this.pagingFisrt;this.loadPage(--t)},loadNext:function(){var t=this.pagingPosition||this.pagingFisrt;this.loadPage(++t)},loadLast:function(){rl.debug("this.getPagingTotalPages() = "+this.getPagingTotalPages()),this.loadPage(this.getPagingTotalPages())},getPagingTotalPages:function(){return this.pagingPagesTotal},setPagingLimit:function(t,e){return t=parseInt(t),t==this.pagingLimit||isNaN(t)?this:(this.pagingLimit=t,void(e&&(this.pagingPosition=1,this.load())))},_readSpecifiedFields:function(t){var e,i,r,a,n=this.cols,s=n.length,o={};if(!o)return null;for(e=0;s>e;e++)a=n[e],i=a.name,r=t.getValue(a.mapping),a.convert&&(r=a.convert(r,i,e,t)),o[i]=r;return o},_readAllFields:function(t){var e,i,r,a,n=this.cols,s=n.length,o=t.getValues();if(!o)return null;for(e=0;s>e;e++)a=n[e],o.hasOwnProperty(a.mapping)&&(i=a.name,r=o[a.mapping],a.convert&&(r=a.convert(r,i,e,t)),delete o[a.mapping],o[i]=r);return o},_read:function(){this._colsConvertsInited||this._initColsConverts();var t,e=this.dataVisitor,i=this.clearMode.toLowerCase(),r=this.readMode.toLowerCase().capitalize(),a="all"==i,n="auto"==i||"deprecated"==i,s=rl.data.Record.LoadStates,o=s.UNCHANGED,d=s.UPDATED,h=[],c=Function.bind(function(){t=this.createRow(this._readOne(e)),this.cacheRawData&&t.setRawData(e.readingRecord),h.push(t)},this);if(this._readOne=this["_read"+r+"Fields"]||this._readSpecifiedFields,this.beginBatchUpdate(),this.rows.length&&this.uniqueCheck){var l,u=this.primaryKey,g={};for(a?this.clear():this.each(function(t){t.setLoadState(o)});e.read();)l=e.getValue(u),(t=this.getById(l))?(t.setValues(this._readOne(e)),this.cacheRawData&&t.setRawData(e.readingRecord),n&&!g[l]&&t.setLoadState(d)):(g[l]=!0,c());n&&this._clearDeprecated(),this.addAll(h)}else{for(a?this.clear():this.each(function(t){t.setLoadState(o)});e.read();)c();this.addAll(h)}this.endBatchUpdate(this._chgMemo,rl.data.Table.BatchUpdateTypes.COMMIT),this.localSort&&this.doLocalSort(),this.fireEvent("load")},doLocalSort:function(){if(this.autoSort){var t=this.sortField||this.defaultSortField;this.sort(t,this.defaultAscSort)}else this.sortField=null},initReq:function(){var t=this.httpRequest;t&&(t.on("success",this.readRequest,this),t.on("failure",this.hndErrorRequest,this),t.on("error",this.hndErrorRequest,this))},updateRequest:function(t){var e=this.httpRequest;e&&e.request(t)},hndErrorRequest:function(t){this.fireEvent("readrequesterror",t)},readRequest:function(){var t,e,i,r=this.httpRequest,a=r.getResponse(),n=this.dataVisitor;try{if(t=n.readResponse(a),e=t.data,!e)throw{description:"Invalid rsp data!"};i=t.meta,i&&(rl.dir(i,this+" readRequest(): meta"),this.pagingRecordsTotal=i[n.rspRecordsTotal],this.pagingPagesTotal=i[n.rspPagesTotal],!this.pagingPagesTotal&&this.pagingLimit>0&&(this.pagingPagesTotal=Math.ceil(i[n.rspRecordsTotal]/parseInt(this.pagingLimit))),this.pagingRecordStart=i[n.rspRecordStart],this.pagingRecordEnd=i[n.rspRecordEnd])}catch(s){return void this.fireEvent("readrequesterror",s)}n.setData(t.data),this._read()},createRow:function(t){var e=this.rowType||rl.data.Table.DefaultRowType;return new e(t)},add:function(t){return t instanceof rl.data.Record?(this.rows.push(t),t.setLoadState(rl.data.Record.LoadStates.ADDED),this._afterAdd(t),t):!1},addAll:function(t){return this.beginBatchUpdate(),Array.each(this.add,t,this),this.endBatchUpdate(t,rl.data.Table.BatchUpdateTypes.ADD),t},insertAt:function(t,e){return t instanceof rl.data.Record?(e>-1?(this.rows.insertAt(t,e),this._afterAdd(t)):this.add(t),t):!1},insertAllAt:function(t,e){this.beginBatchUpdate(),Array.each(function(t,i){this.insertAt(t,e+i)},t,this),this.endBatchUpdate(t,rl.data.Table.BatchUpdateTypes.ADD)},insertBefore:function(t,e){return t instanceof rl.data.Record?(this.rows.insertBefore(t,e),this._afterAdd(t),t):t},insertAllBefore:function(t){this.beginBatchUpdate(),Array.each(this.insertBefore,t,this),this.endBatchUpdate(t,rl.data.Table.BatchUpdateTypes.ADD)},_afterAdd:function(t){t.owner=this,this.batchUpdating||this.fireEvent("add",t)},reomve:function(t){var e=this.rows.indexOf(t);return this.removeAt(e)},removeAt:function(t){var e,i=this.rows;if(t>-1){if(e=this.rows[t],!e)return;if(this.fireEvent("beforeremove",e)===!1)return e;i.removeAt(t),this._afterRemove(e)}return e},reomveById:function(t,e){var i=this.indexOfId(t,e);return this.removeAt(i)},_afterRemove:function(t){this._chgMemo.remove(t),delete t.owner,this.fireEvent("remove",t)},clear:function(){this._chgMemo=[],this.rows=[],this.fireEvent("clear")},_clearDeprecated:function(){for(var t=0,e=this.rows.length;e>t;t++)this.rows[t].isDeprecated()&&(this.removeAt(t),t-=1,e-=1)},_initColsConverts:function(){var t,e=this.dataVisitor;e.read(),Array.each(function(i){t=e.getValue(i.name),i.initSortConvert(t)},this.cols),e.resetIndex(),this._colsConvertsInited=!0},sort:function(t,e){if(this.sortable){e=!!e,t=this.toField(t);var i=this.sortField==t,r=this.rows,a=r[0],n=this.getCol(t);if(n&&n.sortable&&a)if(this.sortField=t,this.isAscSort=e,this.localSort)this._doLocalSort(n,i),this.fireEvent("sort");else{var s={};s[this.reqSortOrder]=e?"asc":"desc",s[this.reqSortField]=t,this.load({dynamicParams:s,successHandler:Function.bind(function(){this.fireEvent("sort")},this)})}}},toggleSort:function(){var t=this.sortField;return t||0===t||(t=this.defaultSortField||0),this.sort(t,!this.isAscSort)},_doLocalSort:function(t,e){var i=this.rows;e?i.reverse():i.sort(this._getColSortFunction(t))},_getColSortFunction:function(t){var e,i=t.sortFunction,r=rl.data.Table.recordsSort,a=this.isAscSort,n=this.sortField,s=t.sortConvert;return e=rl.isFunction(i)?a?function(t,e){return i(t,e)}:function(t,e){return i(e,t)}:a?function(t,e){return r(n,s,t,e)}:function(t,e){return r(n,s,e,t)}},toField:function(t){return isNaN(t)?t:this.cols[t].name},toIndex:function(t){return rl.isNonNullStr(t)?Array.indexOf(function(e){return e.name==t},this.cols):isNaN(t)?-1:t},getCol:function(t){var e=this.cols;return rl.isNonNullStr(t)&&(t=this.toIndex(t)),e[t]},getByIndex:function(t){return this.rows[t]},getById:function(t,e){return t=this.indexOfId(t,e),t>-1?this.rows[t]:void 0},indexOfId:function(t,e){return e=e||this.primaryKey,Array.indexOf(function(i){return i.getValue(e)==t},this.rows)},each:function(t,e,i){Array.each(t,this.rows,e||this,i)},find:function(t,e,i){return Array.find(t,this.rows,e||this,i)},filter:function(t,e,i){return Array.filter(t,this.rows,e||this,i)},beginBatchUpdate:function(){this.batchUpdating=!0},endBatchUpdate:function(t,e){this.batchUpdating=!1,this.fireEvent("batchupdate",t,e)},cancelBatchUpdate:function(){this.batchUpdating=!1},afterRowEdit:function(t){rl.debug(this+" afterRowEdit row= "+t),this._chgMemo.contains(t)||this._chgMemo.push(t),this.batchUpdating||this.fireEvent("change",t,rl.data.Record.ChangeTypes.EDIT)},afterRowCommit:function(t){this._chgMemo.remove(t),this.batchUpdating||this.fireEvent("change",t,rl.data.Record.ChangeTypes.COMMIT)},afterRowReject:function(t){this._chgMemo.remove(t),this.batchUpdating||this.fireEvent("change",t,rl.data.Record.ChangeTypes.REJECT)},commit:function(){var t=this._chgMemo.slice(0);this._chgMemo=[],this.beginBatchUpdate();for(var e=0,i=t.length;i>e;e++)t[e].commit();return this.endBatchUpdate(t,rl.data.Table.BatchUpdateTypes.COMMIT),this},reject:function(){var t=this._chgMemo.slice(0);this._chgMemo=[],this.beginBatchUpdate();for(var e=0,i=t.length;i>e;e++)t[e].reject();return this.endBatchUpdate(t,rl.data.Table.BatchUpdateTypes.REJECT),this},toQueryString:function(){return rl.data.Table.encodeRows2QS(this.rows)},toFormString:function(){return rl.data.Table.encodeRows2FS(this.rows)},toString:function(){return"[object rl.data.Table]"}}}),rl.ext(rl.data.Table,{BatchUpdateTypes:{ADD:1,COMMIT:2,REJECT:3},DefaultColumnType:rl.data.Column,DefaultRowType:rl.data.Row,recordsSort:function(t,e,i,r){var a=i.getValue(t),n=r.getValue(t);return rl.isFunction(e)&&(a=e(a),n=e(n)),rl.data.basicSort(a,n)},encodeRows2QS:function(t){for(var e,i=[],r=0,a=t.length;a>r;r++)e=t[r],i.push(e.toQueryString(),"&");return i.pop(),i.join("")},encodeRows2FS:function(t){for(var e,i=[],r=0,a=t.length;a>r;r++)e=t[r],i.push(e.toFormString());return i.join("")}})});