orderjs.define("lib.dnd.engine",["lib.data.engine","lib.dom.engine","lib.dom.DomWrap","lib.util.CustomUIEventsMgr"],function(){var e=rl.dom,t=rl.util.CustomUIEventsMgr,r=rl.dnd={dragStartTarget:null,_dragPreparing:!1,_b4DndEventData:{},_dragStartDelayTimer:0,_dragStartDelay:1e3,b4Dnd:function(n){r._dragPreparing=!0;var a=rl.ew.init(n),d=this;try{if(t.fireTargetEvent(d,"beforedrag")===!1)return r.afterDnd()}catch(i){return r.afterDnd()}r.dragStartTarget=d,rl.IE?rl.ext(r._b4DndEventData,a.getEvt()):r._b4DndEventData=a.getEvt(),e.addEventListener(document,"mousemove",r.dragStart),e.addEventListener(document,"mouseup",r.dragEnd),r._dragStartDelayTimer=Function.delay(r.dragStart,r._dragStartDelay),document.body.setCapture?document.body.setCapture():window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP)},dragStart:function(n){var a=rl.ew,d=r.dragStartTarget,n=a.init(n).getEvt();n||a.init(r._b4DndEventData),e.removeEventListener(document,"mousemove",r.dragStart),clearTimeout(r._dragStartDelayTimer),e.addEventListener(document,"mousemove",r.draging);try{t.fireTargetEvent(d,"dragstart")}catch(i){return rl.dir(i),r.afterDnd()}},draging:function(e){var n=(rl.ew.init(e),r.dragStartTarget);try{t.fireTargetEvent(n,"draging")}catch(a){return r.afterDnd()}},dragEnd:function(e){var n=(rl.ew.init(e),r.dragStartTarget);if(rl.isElement(n))try{t.fireTargetEvent(n,"dragend"),t.fireTargetEvent(n,"drag")}catch(a){return r.afterDnd()}r.afterDnd()},afterDnd:function(){r._dragStarted=!1,r._dragPreparing=!1,r.dragStartTarget=null,document.body.releaseCapture?document.body.releaseCapture():window.releaseEvents(Event.MOUSEMOVE|Event.MOUSEUP),clearTimeout(r._dragStartDelayTimer),e.removeEventListener(document,"mousemove",r.dragStart),e.removeEventListener(document,"mousemove",r.draging),e.removeEventListener(document,"mouseup",r.dragEnd)},hndDragCancel:function(){if(r._dragPreparing)try{r.dragEnd()}catch(e){}},absolutize:function(t,r,n){t=rl.getDom(t),rl.isElement(t)&&"absolute"!=e.getStyle(t,"position")&&(isNaN(r)&&(r=e.getOffsetX(t)),isNaN(n)&&(n=e.getOffsetY(t)),e.setStyle(t,{position:"absolute",height:t.offsetHeight+"px",width:t.offsetWidth+"px",left:r+"px",top:n+"px"}))},initTargetUIEvent:function(t){e.addEventListener(t,"mousedown",r.b4Dnd,t)},destructTargetUIEvent:function(t){e.removeEventListener(t,"mousedown",r.b4Dnd,t)},toString:function(){return"[object rl.dnd]"}};e.addEventListener(window,"blur",r.hndDragCancel),Array.each(function(e){t.regEvent(e,r.initTargetUIEvent,r.destructTargetUIEvent)},["drag","draging","dragend","dragstart","beforedrag"]),function(){var e=rl.util.CustomUIEventsMgr,t=rl.dnd;rl.ext(t,{_dndMoveStartDataStore:{X:0,Y:0,clientX:0,clientY:0},_dndMoveScopes:new rl.data.MixedMap,_dndMoveB4StartHandler:function(e){var r,n=rl.ew,a=this,d=a.getDragTarget;if(rl.isFunction(d)&&(r=d.call(a.scope,e)),r=r||rl.getDom(a.target),rl.isElement(r)){a.target=r;var i=t._dndMoveStartDataStore,o=r.style;i.X=parseInt(o.left),i.Y=parseInt(o.top),i.clientX=n.clientX(),i.clientY=n.clientY(),a.cancelBubble&&n.stopBubble(),a.cancelCapture&&(r.setCapture?r.setCapture():window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP))}},_dndMovingHandler:function(){var e=rl.ew,r=this,n=r.target;if(rl.isElement(n)){var a=t._dndMoveStartDataStore,d=r.setXY||t._dndMoveSetXY,i=e.clientX(),o=e.clientY(),l=i-a.clientX,g=o-a.clientY,v=a.X+l,s=a.Y+g;d.call(r.scope,n,v,s,l,g),r.cancelBubble&&e.stopBubble()}},_dndMoveendHandler:function(){var e=(rl.ew,this),t=e.target;e.useCapture&&(t.releaseCapture?t.releaseCapture():window.releaseEvents(Event.MOUSEMOVE|Event.MOUSEUP))},_dndMoveSetXY:function(e,t,r){var n=e.style;n.left=t+"px",n.top=r+"px"},toDndMovable:function(r,n){if(r=rl.getDom(r),rl.isElement(r)&&!r.RL_DND_MOVABLE){r.RL_DND_MOVABLE=!0;var a=rl.ext({target:r,cancelBubble:!0},n);t._dndMoveScopes.add(r,a),e.addEventListener(r,"beforedrag",t._dndMoveB4StartHandler,a),e.addEventListener(r,"draging",t._dndMovingHandler,a),e.addEventListener(r,"dragend",t._dndMoveendHandler,a),t.absolutize(a.target)}},unDndMovable:function(r){if(r=rl.getDom(r),rl.isElement(r)){r.RL_DND_MOVABLE=!1;var n=t._dndMoveScopes.get(r);e.removeEventListener(r,"beforedrag",t._dndMoveB4StartHandler,n),e.removeEventListener(r,"draging",t._dndMovingHandler,n)}}}),rl.toDragable=t.toDndMovable,rl.stopDragable=t.unDndMovable}()});