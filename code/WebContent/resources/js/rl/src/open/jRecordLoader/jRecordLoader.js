/**
 * @fileOverview Records loader.
 * Note this moudle required following shims:
 * <code>
	orderjs.config("shim", {
		"open.jquery.jquery" : {
			exports : "jQuery"
		},
		"open.jsrender.jsrender" : {
			deps : ["open.jquery.jquery"]
		}
	});
 * </code>
 * @change
    #1 by prcjack @2014/06/25 Create file.
 */
orderjs.define("open.jRecordLoader.jRecordLoader",["open.jquery.jquery","open.jsrender.jsrender","css>open.jRecordLoader.jRecordLoader"],function(){function t(){return e.extend(new t.RecordLoader,{renderTarget:e.apply(e,arguments)})}var e=orderjs("open.jquery.jquery");return e.extend(t,{rTpl:/\{([\w-]+)(?:\:([\w\.]*)(?:\((.*?)?\))?)?\}/g,format:function(r,o){return e.type("string"==r)&&"object"==e.type(o)?r.replace(t.rTpl,function(t,e){var r=o[e];return void 0===r&&(r=""),r}):""}}),t.RecordLoader=function(){},t.RecordLoader.prototype={combineDataUrl:function(t){var e=this.dataUrl;return e+(e.indexOf("?")>-1?"":"?")+"&start="+t},dataUrl:void 0,dataType:"json",jq:new e,metaField:"meta",msgAllLoaded:"已全部加载，共 {total} 条记录",msgLoadMore:"查看更多({left})",msgLoading:"加载中，请稍后...",msgLoadFailure:"加载错误，点击重新加载",recordHtmlTpl:void 0,recordsCtn:void 0,recordsField:"records",recordsFilter:null,renderTarget:null,_htmlTpl:['<div class="soof_rloader">','<a class="btn load" href="javascript:void(0);">{text}</a>','<div class="progress"></div>',"</div>"].join(""),_loadedRecordsMeta:null,init:function(t){return this._loadedRecordsMeta={loadedCount:0,start:0,total:void 0},this.setOptions(t),this},appendRecords:function(t){return e.isFunction(this.recordsFilter)&&(t=this.recordsFilter(t)),e(this.recordsCtn).append(e(this.recordHtmlTpl).render(t)),this},clear:function(){return this._loadedRecordsMeta={loadedCount:0,start:0,total:void 0},e(this.recordsCtn).html(""),this},initEvents:function(){return this.jq.find(".load").on("click",function(t){return function(){t.loadRecords()}}(this)),this},loadRecords:function(t){var r=this._loadedRecordsMeta;if(r.total>=0&&r.total<=r.loadedCount)return this;var o=this,d=this.combineDataUrl(r.start);return this.updateOnLoading(),e.ajax(e.extend({url:d,dataType:this.dataType,cache:!1,success:function(t){if("object"===e.type(t)&&e.isArray(t[o.recordsField])&&e.isPlainObject(t[o.metaField])){var d=t[o.recordsField],a=t[o.metaField];r.total=a.total,r.total>0?(r.start=r.loadedCount+=d.length,o.appendRecords(d),r.loadedCount>=r.total?(o.updateOnLoad(),o.updateOnLoadAll()):o.updateOnLoad()):(o.updateOnLoad(),o.updateOnLoadAll())}else o.updateOnLoadFailure()},error:function(){o.updateOnLoadFailure()}},t)),this},render:function(){var r=this.renderTarget;if(r instanceof e||(r=this.renderTarget=e(r)),r[0]||(r=this.renderTarget=e(r.selector,r.context)),!r[0])throw new Error(this+"render(): Cant render because this renderTarget is unready or non-exist!");return this.jq=e(t.format(this._htmlTpl,{text:this.msgLoading})).appendTo(r),this.initEvents(),this},setLoaderProgress:function(t){return this.jq.find(".progress").width(t),this},setLoaderText:function(t){return this.jq.find(".load").text(t),this},setOptions:function(t){return e.extend(!0,this,t),this},updateOnLoad:function(){var r=this._loadedRecordsMeta;return this.setLoaderProgress(100*Math.min(1,r.loadedCount/r.total)+"%"),this.setLoaderText(t.format(this.msgLoadMore,{left:r.total-r.loadedCount})),e.isFunction(this.onload)&&this.onload(),this},updateOnLoadAll:function(){var r=this._loadedRecordsMeta;return this.jq.find(".load").addClass("all_loaded"),this.setLoaderText(t.format(this.msgAllLoaded,{total:r.total})),this.setLoaderProgress("100%"),e.isFunction(this.onAllLoad)&&this.onAllLoad(),this},updateOnLoadFailure:function(t){this.setLoaderText(t||this.msgLoadFailure)},updateOnLoading:function(t){this.setLoaderText(t||this.msgLoading)},toString:function(){return"[object jRecordLoader.RecordLoader]"}},t});