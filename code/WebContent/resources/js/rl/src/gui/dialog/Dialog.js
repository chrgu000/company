/**
 * @fileOverview Dialog
 * @change
 	#1 by prcjack Creates file.
	#2 by prcjack @2014/06/06 Fix keepViewInCenter bug.
	#3 by prcjack @2014/10/03 
		Modify content window focus event to mousedown, to avoid the bottom modal dialog(layer) get focus.
 */
orderjs.define("gui.dialog.Dialog",["lib.dnd.engine","gui.engine","gui.Iframe","gui.button.IconButton","gui.menu.ToolBar","css>rl:dialog"],function(){rl.onReady(function(){var t=document.createElement("input");rl.dom.domWarehouse.appendChild(t),rl.gui.dialog.breakIeFocusIce=function(){t.focus()}}),rl.gui.dialog.Dialog=rl.createClass({parent:rl.gui.ComponentBase,construct:function(t){rl.isPrototyping(arguments[0])||(rl.gui.dialog.Dialog.parent.call(this,t),this.dw=new rl.dom.DomWrap,this.dw.useVisibilityShow=!0,this.initialize(),this.autoRenderOnReady&&rl.onReady(Function.bind(this.render,this)))},members:{enableBiClose:!0,useShadow:!0,shadowOffset:void 0,shadowSides:void 0,autoKeepInCenter:!0,bottomBarItems:null,autoRenderOnReady:!0,autoFit:!1,autoDisplayContent:!0,title:"",contentType:"window",content:"",contentIframeType:rl.gui.Iframe,contentIframeName:"",icon:"",iniVisible:!0,dragable:!0,biCloseMode:"auto",biCloseBtnOptions:null,width:"auto",height:"auto",left:"auto",top:"auto",minHeight:50,minWidth:150,modal:!1,theme:"",biCloseTip:"",biCloseIcon:rl.gui.mapImg("dialog/bi_close.gif"),biCloseDisabledIcon:rl.gui.mapImg("dialog/bi_close_disabled.gif"),_contentBorderWidth:1,_frameBorderWidth:5,_titleBarHeight:25,_bottomBarHeight:40,_iconWidth:20,_borderIconBarWidth:80,_htmlTpl:new rl.HtmlTpl('<div class="rl_comp rl_dialog {theme}" id="{id}" style="left:{left}; top:{top};width:{width}; visibility:{visibility};position:absolute; z-index:{zIndex}"><span class="border_icon_bar" id="{biBarId}"></span><table class="border_wrapper" border="0" cellpadding="0" cellspacing="0"><tr><td class="nw">&nbsp;</td><td class="n"><div class="hilite_border"></div></td><td class="ne">&nbsp;</td></tr><tr><td class="w">&nbsp;</td><td class="c"><table class="main_wrapper" border="0" cellspacing="0" cellpadding="0"><tr class="title_bar" id="{titleBarId}"><td class="icon_wrapper"><div id="{iconId}" class="icon" style="background-image:url({iconSrc})"></div></td><td><div id="{titleId}" class="title" style="width:{titleWidth}; ">{title}</div></td><td class="border_icon_space">&nbsp;</td></tr><tr><td colspan="3" class="content_border"><div id="{contentCtnId}" class="content_wrapper" style="height:{contentHeight};">{content}</div><div id="{bottomBarId}" class="bottom_bar"></div></td></tr></table></td><td class="e">&nbsp;</td></tr><tr><td class="sw">&nbsp;</td><td class="s">&nbsp;</td><td class="se">&nbsp;</td></tr></table></div>'),initialize:function(){rl.isNonNullStr(this.id)||(this.id=this.autoId());var t=this.id,i=this.bottomBarItems;this.iconId=t+"_icon",this.titleId=t+"_title",this.biBarId=t+"_biBar",this.contentCtnId=t+"_contentCtn",this.titleBarId=t+"_titleBar",this.bottomBarId=t+"_bottomBar",this._hasBottomBar=rl.isArray(i)||rl.isObject(i)&&i.length,/auto/.test(this.biCloseMode)&&(this.biCloseMode=/window/.test(this.contentType)?"close":"hide"),this.zIndexMgr=rl.gui[this.modal?"modalDialogZIndexMgr":"dialogZIndexMgr"],rl.gui.dialog.dialogMgr.regDialog(this),rl.gui.compStore.add(this.id,this)},initView:function(){this.initContent(),this.initWallSize(),this.autoFit&&this._doAutoFit(),rl.gui.makeUnselectable(this.titleBarId),this.setDragable(this.dragable),this.initBorderIcons(),this.dw.on("contextmenu",this.cancelContextMenu,this),this.dw.on("mousedown",this.focus,this),rl.$(this.titleBarId).on("mousedown",this.focus,this),this.initBottomBar(),this.zIndexMgr.add(this),this.useShadow&&(this.initShadow(),this.iniVisible&&this.shadow.show(this.dw)),this.modal&&this.iniVisible&&this.showModalLayer(),Function.defer(this.refreshView,this)},initSizeAndPosition:function(){var t,i=rl.dom.viewport,e=i.getWidth(),n=i.getHeight();/html|dom/.test(this.contentType)&&"auto"===this.width&&"auto"===this.height&&(this.autoFit=!0),t=this.width,"auto"===t&&(t=e/2),parseInt(t)>=this.minWidth||(t=this.minWidth),this.width=t,t=this.height,"auto"===t&&(t=n/2),parseInt(t)>=this.minHeight||(t=this.minHeight),this.height=t,t=this.left,"auto"===t&&(t=e/2-parseInt(this.width)/2),parseInt(t)>=0||(t=0),this.left=t,t=this.top,"auto"===t&&(t=n/2-parseInt(this.height)/2),parseInt(t)>=0||(t=0),this.top=t},initWallSize:function(){var t=2*this._frameBorderWidth+2*this._contentBorderWidth;this._wallHeight=t+rl.$(this.titleBarId).getHeight()+(this._hasBottomBar?rl.$(this.bottomBarId).getHeight():0),this._wallWidth=t},initContent:function(){if("window"===this.contentType&&!this.contentIframe){var t=this.contentIframe=new this.contentIframeType({name:this.contentIframeName});if(t.render(this.contentCtnId),rl.IE)t.dw.on("mousedown",this.focus,this);else try{rl.$(this.getContentWindow()).on("mousedown",this.focus,this)}catch(i){rl.dir(i,this+" initContent(): error on bind focus to content window!",{type:"err"})}}"html"!==this.contentType&&this.setContent(this.content)},cancelContextMenu:function(t){var i=rl.ew.init(t).getTarget();rl.$(this.contentCtnId).within(i)||rl.ew.stopEvent()},initBorderIcons:function(){this.biCloseBtn=new rl.gui.button.IconButton(rl.ext({tip:this.biCloseTip,icon:this.biCloseIcon,disabled:!this.enableBiClose,_sizeCss:"bi_close",disabledIcon:this.biCloseDisabledIcon,action:Function.bind(this[this.biCloseMode],this),renderTarget:this.biBarId},this.biCloseBtnOptions))},initBottomBar:function(){if(this._hasBottomBar){var t=this.bottomBarItems;!rl.isArray(t)&&t.length&&(t=Array.slice(t)),Array.each(function(t){delete t.width,t.showNormalStateBorder=!0},t,this),this.bottomBar=new rl.gui.menu.ToolBar({autoRenderOnReady:!1,renderTarget:this.bottomBarId,items:t}),Function.defer(this.bottomBar.render,this.bottomBar)}else rl.$(this.bottomBarId).hide()},initShadow:function(){this.shadow||!this.useShadow,this.shadow=this.createShadow(),this.on("widthchange",this.updateShadowOnWidthChange,this),this.on("heightchange",this.updateShadowOnHeightChange,this),this.on("positionchange",this.updateShadowOnPositionChange,this)},createShadow:function(){var t=rl.gui.dialog.dialogMgr;return new rl.gui.Shadow({offset:rl.isDefined(this.shadowOffset)?this.shadowOffset:t.defaultShadowOffset,sides:rl.isDefined(this.shadowSides)?this.shadowSides:t.defaultShadowSides})},updateShadowOnWidthChange:function(t){this.dw.visible()&&this.shadow.alignTo(null,null,t)},updateShadowOnHeightChange:function(t){this.dw.visible()&&this.shadow.alignTo(null,null,null,t)},updateShadowOnPositionChange:function(t,i){this.dw.visible()&&this.shadow.alignTo(t,i)},render:function(t){if(this._rendered)return this;t=this.getRenderTarget(t),this.initSizeAndPosition();var i,e="html"===this.contentType?this.content:"",n=this.width,s=this.height,o=this.iniVisible?"":"hidden",h=rl.dom.addUnit,r={id:this.id,iconId:this.iconId,titleId:this.titleId,biBarId:this.biBarId,contentCtnId:this.contentCtnId,titleBarId:this.titleBarId,bottomBarId:this.bottomBarId,content:e,title:this.title,iconSrc:this.icon,visibility:o,theme:this.theme,left:h(this.left),top:h(this.top),zIndex:this._zIndex,titleWidth:h(this._calTitleWidth(n)),width:h(n),contentHeight:h(s)};return i=this._htmlTpl.renderTo(t,r,this.renderPosition),this.dw.setTarget(i),this.initView(),this._rendered=!0,this.fireEvent("render"),this},setContent:function(t){var i=this.contentType.toLowerCase(),e=rl.getDom(this.contentCtnId);if(e)switch(i){case"html":rl.isNonNullStr(t)&&(e.innerHTML=t),this.refreshView();break;case"dom":t=rl.getDom(t),rl.isElement(t)&&(e.innerHTML="",e.appendChild(t),this.autoDisplayContent&&!rl.$(t).displayed()&&rl.dw.show()),this.refreshView();break;default:this.contentIframe.open(t)}},setTheme:function(t){var i=this.theme;return rl.isNonNullStr(t)&&t!=i&&(this.dw.removeClass(i).addClass(t),this.theme=t,this.fireEvent("themeChange",t,i)),this},getContentWindow:function(){return this.contentIframe?this.contentIframe.getContentWindow():void 0},getContentById:function(t){if(this.contentIframe)try{var i=this.getContentWindow();return i.document.getElementById(t)}catch(e){return}return rl.getDom(t)},enableBIButton:function(t,i){var e=this.getBIButton(t);e&&e.setEnable&&e.setEnable(!!i)},getBIButton:function(t){var i=t;return rl.isNonNullStr(t)&&(i=this["bi"+t.toLowerCase().capitalize()+"Btn"]),i},setDragable:function(t){var i=rl.$(this.titleBarId).dom,e=rl.util.CustomUIEventsMgr;(this.dragable=!!t)?(this._bindedSetXYOnDrag||(this._bindedSetXYOnDrag=Function.bind(this.setXYOnDrag,this)),rl.toDragable(i,{target:this.dw.dom,setXY:this._bindedSetXYOnDrag}),e.addEventListener(i,"dragstart",this.hndDragStart,this),e.addEventListener(i,"dragend",this.hndDragend,this)):(e.removeEventListener(i,"dragstart",this.hndDragStart,this),e.removeEventListener(i,"dragend",this.hndDragend,this),e.stopTargetUIEvent(i,"dragstart"),e.stopTargetUIEvent(i,"dragend"),rl.stopDragable(i))},refreshView:function(){var t=this.getWidth();delete this.width,this.setWidth(t);var i=this.getHeight();delete this.height,this.setHeight(i),this.autoKeepInCenter&&this.keepInCenter(),rl.debug(this+" refreshView(): height = "+i+", width = "+t)},resizeTo:function(t,i){return this.setWidth(t),this.setHeight(i),this.autoKeepInCenter&&this.keepInCenter(),this},keepInCenter:function(){var t,i,e=rl.dom.viewport,n=e.getWidth(),s=e.getHeight(),o=window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft,h=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop;t=n/2-parseInt(this.width)/2,parseInt(t)>=0||(t=0),this.left=t+o,this.dw.setLeft(this.left),rl.debug(this+" keepInCenter(): window scrollLeft = "+h),i=s/2-parseInt(this.height)/2,parseInt(i)>=0||(i=0),this.top=i+h,this.dw.setTop(this.top),this.useShadow&&this.shadow&&this.updateShadowOnPositionChange(t,i)},resizeContentTo:function(t,i){return this.setContentWidth(t),this.setContentHeight(i),this},setHeight:function(t){if(t&&t!==this.height){var i=this.height,e=this._wallHeight;t=this.autoFit?rl.$(this.contentCtnId).setHeight(0).dom.scrollHeight+e:parseInt(t),(isNaN(t)||t<this.minHeight)&&(t=this.minHeight);var n=t-e;rl.$(this.contentCtnId).setHeight(n),this.height=t,t!==i&&this.fireEvent("heightchange",t,i)}},setContentHeight:function(t){return rl.isNumber(t)&&(t+=this._wallHeight),this.setHeight(t)},getHeight:function(){return parseInt(this.height)},setWidth:function(t){if(t&&t!==this.width){var i=this.width,e=this._wallWidth;t=this.autoFit?rl.$(this.contentCtnId).setWidth(0).dom.scrollWidth+e:parseInt(t),(isNaN(t)||t<this.minWidth)&&(t=this.minWidth);var n=t-e,s=this._calTitleWidth(t);this.dw.setWidth(t),rl.$(this.contentCtnId).setWidth(n),rl.$(this.titleId).setWidth(s),this.width=t,t!==i&&this.fireEvent("widthchange",t,i)}},setContentWidth:function(t){return rl.isNumber(t)&&(t+=this._wallWidth),this.setWidth(t)},getWidth:function(){return parseInt(this.width)},getInnerSize:function(){},setXYOnDrag:function(t,i,e){return this.moveTo(i,e)},moveTo:function(t,i){var e=rl.ew,n=rl.dom.viewport,s=e.clientX(),o=e.clientY(),h=n.getWidth(),r=n.getHeight();return s>0&&o>0&&h>s&&r>o&&(this.dw.moveTo(t,i,!1),this.fireEvent("positionchange",t,i)),this},setZIndex:function(t){var i=this._zIndex;return t=parseInt(t),i===t||isNaN(t)?this:(this._zIndex=t,this.dw.setStyle({zIndex:t}),this.useShadow&&this.shadow&&this.shadow.setZIndex(t-1),this.modal&&this.modalLayer&&this.modalLayer.setZIndex(t-2),this)},getZIndex:function(){return this._zIndex},hide:function(){return this.dw.hide(),this.useShadow&&this.shadow.hide(),this.modal&&this.hideModalLayer(),this},show:function(){return this.autoKeepInCenter&&this.keepInCenter(),this.dw.show(),this.useShadow&&this.shadow.show(this.dw),this.modal&&this.showModalLayer(),this},showModalLayer:function(){var t=this.modalLayer,i=rl.gui.dialog.dialogMgr;t||(t=this.modalLayer=rl.gui.maskLayerPool.pull(),t.setZIndex(this.dw.getZIndex(!0)-2)),i.onDialogModalLayerShow(this,t),t.show()},hideModalLayer:function(){var t=this.modalLayer,i=rl.gui.dialog.dialogMgr;t&&(t.hide(),i.onDialogModalLayerHide(this,t),rl.gui.maskLayerPool.push(t),delete this.modalLayer)},close:function(){return this.fireEvent("beforeclose")===!1?!1:(this.dispose(),this.fireEvent("close"),!0)},setIcon:function(t){var i=this.icon;return rl.isNonNullStr(t)&&i!==t?(this.icon=t,rl.$(this.iconId).setStyle({backgroundImage:"url("+t+")"}),this.fireEvent("iconchange",t,i),this):this},getIcon:function(){return this.icon},getTitle:function(){return this.title},setTitle:function(t){var i=this.title;return rl.isNonNullStr(t)||(t=String(t)),i===t?this:(this.title=t,rl.$(this.titleId).setText(t),this.fireEvent("titlechange",t,i),this)},focus:function(){return this.zIndexMgr.bringFrontest(this),!1},blur:function(){},blink:function(){},_calTitleWidth:function(t){return t-2*this._frameBorderWidth-this._iconWidth-this._borderIconBarWidth},_doAutoFit:function(){this.setWidth("auto"),this.setHeight("auto")},hndReuse:function(t){if(rl.isObject(t)&&(t.toFrontest&&this.zIndexMgr.bringFrontest(this),t.bottomBarItems)){var i=t.bottomBarItems;Array.each(function(t,e){t.action=i[e].action},this.bottomBar.items)}},hndDragStart:function(){rl.gui.dialog.dialogMgr.showDragMask()},hndDragend:function(){rl.gui.dialog.dialogMgr.hideDragMask()},hndPagePropertyChange:function(t,i){if(rl.page)if("title"===t)this.setTitle(i);else if("icon"===t)this.setIcon(i);else if("status"===t){var e=rl.page.defaultPageIcon,n=rl.page.defaultPageLoadingIcon;"unload"===i||"init"===i?this.setIcon(n):"load"===i&&this.getIcon()==n&&this.setIcon(e)}},onDispose:function(){if(this.contentIframe){if(rl.IE)rl.gui.dialog.breakIeFocusIce&&rl.gui.dialog.breakIeFocusIce(),this.contentIframe.dw.un("mousedown",this.focus,this);else try{rl.$(this.getContentWindow()).un("mousedown",this.focus,this)}catch(t){}this.contentIframe.dispose()}this.setDragable(!1),this.dw.un("contextmenu",this.cancelContextMenu,this),this.dw.un("mousedown",this.focus,this),rl.$(this.titleBarId).un("mousedown",this.focus,this),this.bottomBar&&this.bottomBar.dispose(),this.useShadow&&this.shadow.dispose(),this.modal&&this.hideModalLayer(),this.zIndexMgr.remove(this),rl.gui.dialog.dialogMgr.unRegDialog(this),this.dw.dispose()},toString:function(){return"[object rl.gui.dialog.Dialog]"}}}),rl.gui.ctype2Classes.add("dialog",rl.gui.dialog.Dialog),rl.gui.dialog.dialogMgr=function(){var t=document.createElement("div");t.className="rl_dialog_drag_mask",rl.onReady(function(){document.body.appendChild(t)});var i=[],e=[],n="rl_frame_name_";return{defaultShadowOffset:6,defaultShadowSides:"trbl",regDialog:function(t){return t instanceof rl.gui.dialog.Dialog?(i.push(t),!0):void 0},unRegDialog:function(t){return!!i.remove(t)},open:function(t,i,e){rl.isString(i)&&(i=i.trim().toLowerCase());var s;if(rl.isNonNullStr(i)?s=rl.gui.dialog.dialogMgr.findItemByPageName(i):i=rl.autoId(n),s)s.setContent(t),s.hndReuse(e);else{var o=e&&/html|dom/.test(e.contentType)?e:rl.fill({contentType:"window",contentIframeName:i,content:t},e);s=new rl.gui.dialog.Dialog(o)}return s},findItemByPageElement:function(t){return Array.find(function(i){var e=i.contentIframe;return e&&e.dw.dom===t},i)},findItemByPageName:function(t){return Array.find(function(i){return i.contentIframeName===t},i)},showDragMask:function(){if(rl.VER_IE<7){var i=rl.dom.viewport;rl.$(t).setHeight(i.getDocumentHeight()).setWidth(i.getDocumentWidth())}rl.$(t).show()},hideDragMask:function(){rl.$(t).hide()},onDialogModalLayerShow:function(t,i){e.contains(i)||e.push(i),1==e.length&&(rl.$(document.body).addClass("rl_dialog_modal_mode"),rl.gui.maskLayerPool.adjustLayerSize(i))},onDialogModalLayerHide:function(t,i){var n=e.indexOf(i);n>-1&&e.removeAt(n),e.length||rl.$(document.body).removeClass("rl_dialog_modal_mode")},toString:function(){return"[object rl.gui.dialog.dialogMgr]"}}}()});