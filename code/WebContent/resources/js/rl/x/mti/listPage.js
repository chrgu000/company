/**
 * @fileOverview Defines standard list page.
 * @change
 	#1 by prcjack @2013/4/12 
	#2 by prcjack @2013/4/25 add dataUrl support for tree in treeList page.
	#3 by prcjack @2013/5/10 add listPageSearchResetBtn renference and defaultSearchFormName.
	#4 by prcjack @2013/10/6 
		remove listPageSearchResetBtn renference;
		add addAutoSearchToSearchDialog;
		add check for creating rlx.mti.listPageToolbar if necessary.
	#4 by prcjack @2014/02/27 Fix cancel form submit on press "enter" bug. 
	#5 by prcjack @2014/05/28 Remove tree list page part.
	#6 by prcjack @2014/05/29 Defer to load dialog module.
 */
orderjs.define("x:mti.listPage",["lib.rpc.engine","lib.rpc.OneoffSdtHelperMgr","lib.data.bridge.JsonListVisitor","gui.menu.ToolBar","gui.grid.Grid","gui.box.Box","css>x:mti.css.query_form"],function(){rl.createNamespace("rlx.mti",{defaultSearchFormName:"queryForm",searchBtnOptions:{id:"search",text:rl.getG11nSource("search")||"Search",icon:rl.XROOT_PATH+"mti/image/common/search.gif",action:function(){rlx.mti.listPageSearchDialog.show()}},searchResetBtnOptions:{id:"clearSearch",text:rl.getG11nSource("searchReset")||"reset search",iniVisible:!1,icon:rl.XROOT_PATH+"mti/image/common/search_reset.gif",action:function(){rlx.mti.resetListPageGridSearch()}},addAutoSearchToSearchDialog:function(){function e(){rl.$(t.content).on("keypress",function(e){var r=rl.ew.init(e);if(13==r.keyCode()){var a=t.bottomBar;if(a){var i=a.getItemById("search");i&&i.action&&(i.action(),r.stopBubble())}}return!1})}var t=rlx.mti.listPageSearchDialog;return!t instanceof rl.gui.dialog.Dialog?!1:(t._rendered?e():t.on("render",e),t)},resetListPageGridSearch:function(e){var t=rlx.mti,r=t.listPageGrid.dataSource,a=document[rlx.mti.defaultSearchFormName];if(a&&a.reset(),rl.isString(e)&&(r.httpRequest.url=e),r.pagingPosition=1,r.load(),t.listPageToolbar){var i=t.listPageToolbar.getItemById(t.searchResetBtnOptions.id);i&&i.hide()}},cancelListPageGridSearchFormSubmit:function(){var e=document[rlx.mti.defaultSearchFormName];rl.$(e).isTag("form")&&rl.$(e).on("submit",rlx.mti.cancelSubmit)},cancelSubmit:function(e){return rl.ew.init(e).stopEvent(),!1},createToolbar:function(e){var t=(rlx.mti,rl.ext({},e));rl.isArray(t.items)&&(t.noMenuSplit||t.items.unshift(new rl.gui.menu.MenuSplit(5)),rl.each(t.items,function(e,r){rl.isNonNullStr(e)&&("search"==e&&(t.items[r]=rlx.mti.searchBtnOptions),"searchReset"==e&&(t.items[r]=rlx.mti.searchResetBtnOptions))})),delete t.noMenuSplit;var r=new rl.gui.menu.ToolBar(rl.ext({autoRenderOnReady:!1},t));return r},createGrid:function(e){var t=(rlx.mti,rl.ext({},e)),r=new rl.rpc.XHRequest({url:t.dataUrl,responseType:"json",sendData:t.sendData===!1?null:t.sendData||rlx.mti.defaultSearchFormName,async:!0});delete t.dataUrl,delete t.sendData;var a=new rl.data.JsonListVisitor({fields:t.dataFields,rspRecords:"data"});delete t.dataFields;var i=new rl.data.Table(rl.ext({uniqueCheck:rl.isDefined(t.dataUniqueCheck)?t.dataUniqueCheck:!!t.dataPrimaryKey,primaryKey:t.dataPrimaryKey,httpRequest:r,reqPagingPosition:"jp",reqPagingLimit:"perPage",dataVisitor:a},t.dataOptions));delete t.dataPrimaryKey,delete t.noRowNumberingColumn;var o={limitSelectedIndex:2,limitItems:[{text:"20",value:20},{text:"50",value:50},{text:"100",value:100},{text:"200",value:200}]};t.pbOptions?rl.fill(t.pbOptions,o):t.pbOptions=o;var l=new rl.Grid(rl.ext({dataSource:i,enbaleMultiSelect:!0,clickToSelect:!0,deferRenderBody:!0},t));return l},createSearchDialog:function(e){var t=rlx.mti,r=rl.ext({},e),a=new rl.gui.dialog.Dialog(rl.ext({title:rl.getG11nSource("searchDialog")||"search dialog",icon:rl.XROOT_PATH+"mti/image/common/search.gif",contentType:"dom",iniVisible:!1,theme:"lightgray",shadowOffset:4,content:rlx.mti.defaultSearchFormName,bottomBarItems:[{id:"search",text:rl.getG11nSource("searchButtonText")||"search",action:function(){var e=t.listPageGrid.dataSource;if(e.pagingPosition=1,e.load(),a.hide(),t.listPageToolbar){var r=t.listPageToolbar.getItemById(t.searchResetBtnOptions.id);r&&r.show()}}}]},r));return a},createListPage:function(e){var t=rlx.mti;e.searchDialog&&(orderjs("gui.dialog.Dialog"),orderjs(function(){var r=rl.ext({},e.searchDialog);t.listPageSearchDialog=t.createSearchDialog(r),r.autoSearchOnPressEnter!==!1&&t.addAutoSearchToSearchDialog()})),e.toolbar&&(t.listPageToolbar=t.createToolbar(e.toolbar)),t.listPageGrid=t.createGrid(e.grid),e.pageLayouted||(rl.layoutBody({north:e.toolbar?{iniSize:30,comp:t.listPageToolbar}:null,center:{margin:"0 5 0 5",comp:t.listPageGrid}}),rl.onReady(function(){rl.$(document.body).addClass("transi_line")})),rl.onReady(function(){rlx.mti.cancelListPageGridSearchFormSubmit()})}})});